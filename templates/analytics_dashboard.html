<!doctype html>
<html lang="en" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Analytics Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/element_sdk.js" onerror="console.warn('element_sdk.js not found, continuing without it')"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&amp;display=swap" rel="stylesheet">
  <style>
  body {
    box-sizing: border-box;
  }
  
  :root {
    --color-primary: #6366F1;
    --color-surface: #FFFFFF;
    --color-text: #1E293B;
    --color-bg: #F1F5F9;
    --color-accent: #10B981;
    --color-border: #E2E8F0;
    --color-muted: #64748B;
    --color-hover: #F8FAFC;
    /* aliases for redesigned Test Flow */
    --color-surface-hover: #F8FAFC;
    --color-success: #10B981;
    --color-danger: #EF4444;
  }
  .dark {
    --color-primary: #818CF8;
    --color-surface: #1E293B;
    --color-text: #F1F5F9;
    --color-bg: #0F172A;
    --color-accent: #34D399;
    --color-border: #334155;
    --color-muted: #94A3B8;
    --color-hover: #334155;
    /* aliases for redesigned Test Flow */
    --color-surface-hover: #334155;
    --color-success: #34D399;
    --color-danger: #FCA5A5;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  html, body { height: 100%; }
  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    background: var(--color-bg);
    color: var(--color-text);
    transition: background-color 0.3s, color 0.3s;
    font-size: 15px;
    line-height: 1.6;
  }
  .app-wrapper {
    min-height: 100%;
    width: 100%;
    overflow: auto;
  }
  header {
    background: var(--color-surface);
    border-bottom: 2px solid var(--color-border);
    padding: 1.25rem 1.5rem;
    position: sticky;
    top: 0;
    z-index: 50;
    backdrop-filter: blur(8px);
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
  }
  .header-content {
    max-width: 1400px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  h1 {
    font-size: 1.75rem;
    font-weight: 800;
    color: var(--color-text);
    letter-spacing: -0.025em;
  }
  .header-actions {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }
  .icon-btn {
    width: 42px;
    height: 42px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--color-bg);
    border: 1.5px solid var(--color-border);
    color: var(--color-muted);
    cursor: pointer;
    transition: all 0.2s;
  }
  .icon-btn:hover {
    background: var(--color-hover);
    border-color: var(--color-primary);
    color: var(--color-primary);
    transform: translateY(-1px);
  }
  .btn-primary {
    background: var(--color-primary);
    color: white;
    padding: 0.625rem 1.25rem;
    border-radius: 10px;
    border: none;
    font-weight: 600;
    font-size: 0.9375rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.2s;
    box-shadow: 0 2px 8px rgba(99, 102, 241, 0.25);
  }
  .btn-primary:hover {
    background: #4F46E5;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.35);
  }
  .btn-ghost {
    background: transparent;
    color: var(--color-muted);
    padding: 0.625rem 1.25rem;
    border-radius: 10px;
    border: 1.5px solid var(--color-border);
    font-weight: 600;
    font-size: 0.9375rem;
    cursor: pointer;
    transition: all 0.2s;
  }
  .btn-ghost:hover {
    background: var(--color-hover);
    border-color: var(--color-primary);
    color: var(--color-primary);
  }
  .btn-mini{
    padding: 0.45rem 0.85rem;
    border-radius: 10px;
    font-size: 0.875rem;
    font-weight: 700;
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
  }
  main {
    max-width: 1400px;
    margin: 0 auto;
    padding: 2rem 1.5rem;
  }
  .panel {
    background: var(--color-surface);
    border-radius: 16px;
    padding: 1.75rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    border: 1.5px solid var(--color-border);
    transition: all 0.3s;
  }
  .panel:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  }
  h2 {
    font-size: 1.625rem;
    font-weight: 800;
    color: var(--color-text);
    letter-spacing: -0.025em;
  }
  h3 {
    font-size: 1.125rem;
    font-weight: 700;
    color: var(--color-text);
  }
  .kpi-grid{
    display: grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap: 1rem;
  }
  @media (max-width: 1024px){
    .kpi-grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
  }
  @media (max-width: 640px){
    .kpi-grid{ grid-template-columns: 1fr; }
  }
  .kpi-card{
    background: linear-gradient(180deg, rgba(99,102,241,.10), rgba(99,102,241,0) 56%), var(--color-surface);
    border: 1.5px solid var(--color-border);
    border-radius: 16px;
    padding: 1.25rem 1.25rem 1.1rem;
    box-shadow: 0 10px 22px rgba(15, 23, 42, 0.06);
    transition: transform .15s, box-shadow .15s, border-color .15s;
  }
  .dark .kpi-card{
    background: linear-gradient(180deg, rgba(129,140,248,.12), rgba(129,140,248,0) 56%), var(--color-surface);
    box-shadow: 0 10px 22px rgba(0, 0, 0, 0.35);
  }
  .kpi-card:hover{
    transform: translateY(-2px);
    border-color: rgba(99,102,241,.45);
    box-shadow: 0 16px 30px rgba(15, 23, 42, 0.10);
  }
  .kpi-label{
    font-size: .85rem;
    font-weight: 700;
    color: var(--color-muted);
    letter-spacing: .02em;
  }
  .kpi-value{
    margin-top: .5rem;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap: .75rem;
  }
  .flow-table th, .flow-table td{
    text-align: center;
    vertical-align: middle;
  }
  .flow-table td:first-child, .flow-table th:first-child{
    text-align: left;
  }
  .flow-cell{
    display:flex;
    gap: .5rem;
    justify-content:center;
    align-items:center;
    flex-wrap:wrap;
  }
  .flow-mix-btn{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    min-width: 54px;
    padding: 6px 10px;
    border-radius: 10px;
    border: 1px solid var(--color-border);
    font-weight: 800;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    cursor:pointer;
    transition: all .15s;
    background: var(--color-bg);
    color: var(--color-text);
  }
  .flow-mix-btn:hover{
    transform: translateY(-1px);
    box-shadow: 0 6px 16px rgba(15,23,42,.08);
  }
  .flow-mix-btn[disabled]{
    opacity:.55;
    cursor:not-allowed;
    transform:none;
    box-shadow:none;
  }
  .flow-pass-num{ color: #059669; font-weight: 900; }
  .dark .flow-pass-num{ color: #34D399; }
  .flow-fail-num{ color: #DC2626; font-weight: 900; }
  .dark .flow-fail-num{ color: #FCA5A5; }
  .flow-slash{ color: var(--color-muted); font-weight: 900; padding: 0 .15rem; }
  .flow-group-row td{
    background: var(--color-bg);
    color: var(--color-muted);
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: .06em;
  }

  /* ==========================
     Test Flow (Redesigned)
     ========================== */
  #test-flow-panel.card{
    padding: 0;
    overflow: hidden;
  }
  #test-flow-panel .card-header{
    padding: 1.5rem 1.75rem 1.25rem;
    border-bottom: 1.5px solid var(--color-border);
    background: var(--color-surface);
  }
  #test-flow-panel .card-header-row{
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 1rem;
  }
  #test-flow-panel .tf-legend{
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--color-muted);
    font-size: 0.875rem;
    white-space: nowrap;
    padding-top: 0.15rem;
  }
  #test-flow-panel .tf-legend .demo-pill{
    display: inline-flex;
    align-items: center;
    gap: 0.1rem;
    padding: 0.25rem 0.5rem;
    border-radius: 999px;
    border: 1px solid var(--color-border);
    background: var(--color-bg);
    font-weight: 800;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  }
  #test-flow-panel .tf-legend .pass-count{ color: var(--color-success); }
  #test-flow-panel .tf-legend .fail-count{ color: var(--color-danger); }
  #test-flow-panel .tf-legend .slash{ color: var(--color-muted); font-weight: 900; padding: 0 0.05rem; }
  #test-flow-panel .tf-range{
    color: var(--color-muted);
    font-size: 0.875rem;
    font-weight: 700;
    white-space: nowrap;
  }
  #test-flow-panel .table-container{
    overflow-x: auto;
    background: var(--color-surface);
  }
  #test-flow-table{
    width: 100%;
    border-collapse: collapse;
    font-size: 0.875rem;
  }
  #test-flow-table thead{
    background: linear-gradient(to bottom, var(--color-surface-hover), var(--color-surface));
    position: sticky;
    top: 0;
    z-index: 10;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  }
  #test-flow-table th{
    padding: 1rem 0.75rem;
    text-align: left;
    font-weight: 600;
    color: var(--color-text);
    border-bottom: 2px solid var(--color-border);
    white-space: nowrap;
  }
  /* align station headers with centered station cells */
  #test-flow-table th:nth-child(n+3){
    text-align: center;
    padding: 0.75rem 0.5rem;
  }
  #test-flow-table td{
    padding: 0.875rem 0.75rem;
    color: var(--color-text);
  }
  #test-flow-table tbody tr{
    border-bottom: 1px solid var(--color-border);
    transition: background-color 0.15s ease;
  }
  #test-flow-table tbody tr:hover{
    background-color: var(--color-surface-hover);
  }
  #test-flow-table tbody tr:first-child{
    background: linear-gradient(to right, rgba(59, 130, 246, 0.08), rgba(59, 130, 246, 0.02));
    font-weight: 600;
    border-bottom: 2px solid var(--color-primary);
  }
  #test-flow-table tbody tr:first-child:hover{
    background: linear-gradient(to right, rgba(59, 130, 246, 0.12), rgba(59, 130, 246, 0.04));
  }

  /* station result cells */
  #test-flow-table td[data-station-cell]{
    text-align: center;
    padding: 0.5rem;
  }
  #test-flow-table button[data-flow="1"]{
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.15rem;
    padding: 0.35rem 0.5rem;
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
    min-width: 64px;
    line-height: 1.1;
  }
  #test-flow-table button[data-flow="1"]:hover:not(:disabled){
    background: var(--color-surface-hover);
    border-color: var(--color-primary);
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  #test-flow-table button[data-flow="1"]:disabled{
    opacity: 0.4;
    cursor: not-allowed;
  }
  #test-flow-table button[data-flow="1"] .pass-count{
    color: var(--color-success);
    font-weight: 700;
    font-size: 1rem;
    line-height: 1.1;
  }
  #test-flow-table button[data-flow="1"] .fail-count{
    color: var(--color-danger);
    font-weight: 700;
    font-size: 1rem;
    line-height: 1.1;
  }
  #test-flow-table button[data-flow="1"] .slash{
    color: var(--color-muted);
    font-weight: 800;
    font-size: 0.95rem;
    padding: 0 0.05rem;
  }
  /* empty state marker for station cells */
  #test-flow-table td[data-station-cell]:empty::after{
    content: '—';
    color: var(--color-muted);
    font-size: 1.25rem;
  }
  @media (max-width: 768px){
    #test-flow-table{ font-size: 0.8125rem; }
    #test-flow-table th, #test-flow-table td{ padding: 0.625rem 0.5rem; }
    #test-flow-table button[data-flow="1"]{ min-width: 56px; padding: 0.3rem 0.45rem; }
  }
  .input-field {
    width: 100%;
    padding: 0.75rem 1rem;
    border: 1.5px solid var(--color-border);
    border-radius: 10px;
    background: var(--color-bg);
    color: var(--color-text);
    font-size: 0.9375rem;
    font-weight: 500;
    transition: all 0.2s;
    font-family: inherit;
  }
  .input-field:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
  }
  .toggle-group {
    display: flex;
    background: var(--color-bg);
    border-radius: 10px;
    padding: 0.375rem;
    gap: 0.375rem;
    border: 1.5px solid var(--color-border);
  }
  .toggle-btn {
    padding: 0.5rem 1rem;
    border-radius: 8px;
    background: transparent;
    border: none;
    color: var(--color-muted);
    font-weight: 600;
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.2s;
  }
  .toggle-btn.active {
    background: var(--color-surface);
    color: var(--color-primary);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.06);
  }
  .data-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    font-size: 0.9375rem;
  }
  .data-table thead th {
    background: var(--color-bg);
    padding: 1rem 1.25rem;
    text-align: left;
    font-weight: 700;
    font-size: 0.875rem;
    color: var(--color-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    border-bottom: 2px solid var(--color-border);
    position: sticky;
    top: 0;
  }
  .data-table tbody td {
    padding: 1rem 1.25rem;
    border-bottom: 1px solid var(--color-border);
    color: var(--color-text);
    font-weight: 500;
  }
  .data-table tbody tr {
    transition: background 0.15s;
  }
  .data-table tbody tr:hover {
    background: var(--color-hover);
  }
  .status-badge {
    display: inline-flex;
    align-items: center;
    padding: 0.375rem 0.875rem;
    border-radius: 8px;
    font-weight: 700;
    font-size: 0.875rem;
    letter-spacing: 0.02em;
  }
  .status-success {
    background: #D1FAE5;
    color: #065F46;
  }
  .dark .status-success {
    background: rgba(16, 185, 129, 0.15);
    color: #6EE7B7;
  }
  .status-danger {
    background: #FEE2E2;
    color: #991B1B;
  }
  .dark .status-danger {
    background: rgba(239, 68, 68, 0.15);
    color: #FCA5A5;
  }
  .status-warning {
    background: #FEF3C7;
    color: #92400E;
  }
  .dark .status-warning {
    background: rgba(251, 191, 36, 0.15);
    color: #FCD34D;
  }
  .spinner {
    width: 40px;
    height: 40px;
    border: 4px solid rgba(99, 102, 241, 0.2);
    border-top-color: var(--color-primary);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  .loading-overlay {
    position: fixed;
    inset: 0;
    background: rgba(15, 23, 42, 0.7);
    backdrop-filter: blur(4px);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 100;
  }
  .loading-overlay.active { display: flex; }
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(15, 23, 42, 0.75);
    backdrop-filter: blur(4px);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 100;
    padding: 1.5rem;
  }
  .modal-overlay.active { display: flex; }
  .modal-content {
    background: var(--color-surface);
    border-radius: 16px;
    padding: 2rem;
    max-width: 500px;
    width: 100%;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    border: 1.5px solid var(--color-border);
  }
  /* Upload modal (bonepile mapping) needs more room */
  #upload-modal .modal-content{
    max-width: 980px;
    max-height: 85vh;
    overflow: auto;
  }
  .bp-card{
    background: var(--color-bg);
    border: 1.5px solid var(--color-border);
    border-radius: 14px;
    padding: 14px;
  }
  .bp-badge{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding: 2px 10px;
    border-radius: 999px;
    border: 1px solid var(--color-border);
    font-size: 12px;
    font-weight: 700;
    color: var(--color-muted);
    background: var(--color-surface);
  }
  .bp-badge.ok{ color: var(--color-success); border-color: rgba(16,185,129,.35); }
  .bp-badge.err{ color: var(--color-danger); border-color: rgba(239,68,68,.35); }
  .bp-grid{
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }
  @media (max-width: 768px){
    .bp-grid{ grid-template-columns: 1fr; }
    #upload-modal .modal-content{ max-width: 96vw; }
  }
  .bp-label{
    font-size: 12px;
    font-weight: 700;
    color: var(--color-muted);
    margin-bottom: 6px;
  }
  .bp-input, .bp-select{
    width: 100%;
    padding: 10px 12px;
    border-radius: 10px;
    border: 1.5px solid var(--color-border);
    background: var(--color-surface);
    color: var(--color-text);
    outline: none;
    transition: border-color .15s, box-shadow .15s;
  }
  .bp-input:focus, .bp-select:focus{
    border-color: rgba(99,102,241,.7);
    box-shadow: 0 0 0 4px rgba(99,102,241,.15);
  }
  .bp-actions{
    display:flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items:center;
    justify-content:flex-end;
    margin-top: 12px;
  }
  .bp-mini{
    padding: 0.5rem 0.75rem;
    border-radius: 10px;
    border: 1.5px solid var(--color-border);
    background: var(--color-surface);
    color: var(--color-text);
    font-weight: 800;
    font-size: 13px;
    cursor: pointer;
    transition: all .15s;
  }
  .bp-mini:hover{
    border-color: rgba(99,102,241,.7);
    transform: translateY(-1px);
  }
  .dispo-agg-btn.active {
    background: var(--color-primary);
    color: white;
    border-color: var(--color-primary);
  }
  .metric-btn{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    min-width: 54px;
    padding: 6px 10px;
    border-radius: 10px;
    border: 1px solid var(--color-border);
    background: var(--color-bg);
    color: var(--color-text);
    font-weight: 800;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    cursor: pointer;
    transition: all .15s;
  }
  .metric-btn:hover{
    border-color: rgba(99,102,241,.7);
    box-shadow: 0 6px 16px rgba(15,23,42,.08);
    transform: translateY(-1px);
  }
  .metric-btn:active{
    transform: translateY(0);
  }
  .metric-btn[disabled]{
    opacity: .55;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }
  .animate-in {
    animation: fadeInUp 0.5s ease-out forwards;
    opacity: 0;
  }
  .delay-1 { animation-delay: 0.1s; }
  .delay-2 { animation-delay: 0.2s; }
  .delay-3 { animation-delay: 0.3s; }
  .delay-4 { animation-delay: 0.4s; }
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  @media (max-width: 768px) {
    header { padding: 1rem; }
    h1 { font-size: 1.375rem; }
    main { padding: 1.25rem 1rem; }
    .panel { padding: 1.25rem; }
    .header-actions { gap: 0.5rem; }
    .icon-btn { width: 38px; height: 38px; }
  }

  /* Sticky API status (bottom-left, always visible) */
  .api-status {
    position: fixed;
    left: 14px;
    bottom: 14px;
    z-index: 250;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0.75rem;
    border-radius: 999px;
    border: 1.5px solid var(--color-border);
    background: var(--color-surface);
    color: var(--color-text);
    box-shadow: 0 10px 22px rgba(15, 23, 42, 0.10);
    font-weight: 700;
    font-size: 0.875rem;
    max-width: min(520px, calc(100vw - 28px));
    pointer-events: none;
  }
  .api-status .dot{
    width: 10px;
    height: 10px;
    border-radius: 999px;
    background: var(--color-muted);
    flex: 0 0 auto;
  }
  .api-status .text{
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  .api-status.ok .dot{ background: var(--color-accent); }
  .api-status.busy .dot{ background: var(--color-primary); }
  .api-status.warn .dot{ background: #F59E0B; }
  .api-status.err .dot{ background: #EF4444; }
  .api-status.busy{ border-color: rgba(99,102,241,.45); }
  .api-status.err{ border-color: rgba(239,68,68,.45); }
  .api-status.warn{ border-color: rgba(245,158,11,.45); }
 </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript" onerror="console.warn('data_sdk.js not found, continuing without it')"></script>
 </head>
 <body class="h-full">
  <div class="app-wrapper">
   <header>
    <div class="header-content">
     <h1 id="dashboard-title">Analytics Dashboard</h1>
     <div class="header-actions"><button class="icon-btn" id="theme-toggle" title="Toggle theme">
       <svg id="sun-icon" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewbox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
       </svg>
       <svg id="moon-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
      </svg></button>
      <button class="btn-ghost btn-mini" id="export-all" type="button" title="Export all dashboard data to CSV">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v12m0 0l-3-3m3 3l3-3M4 17v2a2 2 0 002 2h12a2 2 0 002-2v-2"></path>
        </svg>
        Export All
      </button>
      <button class="btn-primary" id="upload-btn" type="button">
       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
       </svg> Upload </button>
     </div>
    </div>
   </header>
   <main><!-- Filter Panel -->
    <div class="panel mb-8 animate-in delay-1">
     <div class="flex items-center justify-between mb-6">
      <h3 class="text-lg font-semibold" style="color: var(--color-text);">Filters &amp; Time Range</h3>
     </div>
     <div class="grid grid-cols-1 md:grid-cols-2 gap-6"><!-- Start Time -->
      <div><label class="block text-sm font-bold mb-3" style="color: var(--color-text);">Start Time</label>
       <div class="grid grid-cols-2 gap-3">
        <div><label for="start-date" class="block text-xs font-semibold mb-2" style="color: var(--color-muted);">Date</label> <input type="date" id="start-date" class="input-field w-full">
        </div>
        <div><label for="start-time" class="block text-xs font-semibold mb-2" style="color: var(--color-muted);">Time (24h)</label> <input type="time" id="start-time" step="60" class="input-field w-full font-mono" value="00:00">
        </div>
       </div>
      </div><!-- End Time -->
      <div><label class="block text-sm font-bold mb-3" style="color: var(--color-text);">End Time</label>
       <div class="grid grid-cols-2 gap-3">
        <div><label for="end-date" class="block text-xs font-semibold mb-2" style="color: var(--color-muted);">Date</label> <input type="date" id="end-date" class="input-field w-full">
        </div>
        <div><label for="end-time" class="block text-xs font-semibold mb-2" style="color: var(--color-muted);">Time (24h)</label> <input type="time" id="end-time" step="60" class="input-field w-full font-mono" value="23:59">
        </div>
       </div>
      </div>
     </div>
     <div class="mt-6 flex items-center justify-between gap-3 flex-wrap">
      <div class="text-sm" style="color: var(--color-muted);">
        <span class="font-bold" style="color: var(--color-text);">SFC Fail Result</span>
        <span class="ml-2">Data from SFC API for selected date range.</span>
      </div>
      <div class="flex gap-3">
        <button class="btn-primary" id="apply-filter" type="button">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24">
         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg> Apply Filter </button>
      </div>
     </div>
    </div>

    <!-- KPI Cards -->
    <div class="kpi-grid mb-8 animate-in delay-2" id="kpi-row">
      <div class="kpi-card">
        <div class="kpi-label">Total Tests Conducted</div>
        <div class="kpi-value">
          <div id="kpi-tested" class="text-3xl font-extrabold" style="color: var(--color-text);">-</div>
          <button class="metric-btn" id="kpi-tested-btn" data-metric="tested" data-segment="total">View</button>
        </div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Passed Tests</div>
        <div class="kpi-value">
          <div id="kpi-pass" class="text-3xl font-extrabold" style="color: var(--color-text);">-</div>
          <button class="metric-btn" id="kpi-pass-btn" data-metric="pass" data-segment="total">View</button>
        </div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Failed Tests</div>
        <div class="kpi-value">
          <div id="kpi-fail" class="text-3xl font-extrabold" style="color: var(--color-text);">-</div>
          <button class="metric-btn" id="kpi-fail-btn" data-metric="fail" data-segment="total">View</button>
        </div>
      </div>
    </div>

    <h2 id="summary-title" class="text-2xl font-bold mb-6 animate-in delay-2" style="color: var(--color-text);">Summary Overview</h2><!-- Summary Matrix -->
    <div class="panel mb-8 animate-in delay-2">
     <div class="flex items-center justify-between mb-5">
      <h3 class="text-lg font-semibold" style="color: var(--color-text);">Tray Summary (Unique SN)</h3>
      <div class="flex items-center gap-3">
        <span class="text-sm font-semibold" style="color: var(--color-muted);" id="range-note-summary">-</span>
        <button class="btn-ghost btn-mini" id="export-summary-xlsx" type="button" title="Export Tray Summary to Excel">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v12m0 0l-3-3m3 3l3-3M4 17v2a2 2 0 002 2h12a2 2 0 002-2v-2"></path>
          </svg>
          Export Excel
        </button>
      </div>
     </div>
     <div class="overflow-x-auto">
      <table class="data-table" id="summary-matrix">
       <thead>
        <tr>
         <th>Metric</th>
         <th>BP</th>
         <th>Fresh</th>
         <th>Total</th>
        </tr>
       </thead>
       <tbody>
        <tr>
         <td class="font-bold">Tested</td>
         <td class="font-mono" id="m-tested-bp">-</td>
         <td class="font-mono" id="m-tested-fresh">-</td>
         <td class="font-mono" id="m-tested-total">-</td>
        </tr>
        <tr>
         <td class="font-bold">Pass</td>
         <td class="font-mono" id="m-pass-bp">-</td>
         <td class="font-mono" id="m-pass-fresh">-</td>
         <td class="font-mono" id="m-pass-total">-</td>
        </tr>
        <tr>
         <td class="font-bold">Fail</td>
         <td class="font-mono" id="m-fail-bp">-</td>
         <td class="font-mono" id="m-fail-fresh">-</td>
         <td class="font-mono" id="m-fail-total">-</td>
        </tr>
       </tbody>
      </table>
     </div>
    </div><!-- SKU Table -->
    <div class="panel mb-8 animate-in delay-3">
     <div class="flex items-center justify-between mb-5">
      <h3 class="text-lg font-semibold" style="color: var(--color-text);">SKU (Part Number) Summary</h3>
      <div class="flex items-center gap-3">
        <span class="text-sm font-semibold" style="color: var(--color-muted);" id="range-note-sku">-</span>
        <button class="btn-ghost btn-mini" id="export-sku-xlsx" type="button" title="Export SKU table to Excel">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v12m0 0l-3-3m3 3l3-3M4 17v2a2 2 0 002 2h12a2 2 0 002-2v-2"></path>
          </svg>
          Export Excel
        </button>
      </div>
     </div>
     <div class="overflow-x-auto">
      <table class="data-table" id="sku-table">
       <thead>
        <tr>
         <th>SKU</th>
         <th>Tested</th>
         <th>Pass</th>
         <th>Fail</th>
        </tr>
       </thead>
       <tbody id="sku-tbody">
        <tr>
         <td colspan="4" style="color: var(--color-muted);">No data yet. Apply a filter to load.</td>
        </tr>
       </tbody>
      </table>
     </div>
    </div><!-- Breakdown Table -->
    <div class="panel mb-8 animate-in delay-4">
     <div class="flex items-center justify-between mb-5">
      <h3 class="text-lg font-semibold" style="color: var(--color-text);">Time Breakdown</h3>
      <div class="flex items-center gap-3">
        <div class="toggle-group">
          <button class="toggle-btn active" id="agg-daily">Daily</button>
          <button class="toggle-btn" id="agg-weekly">Weekly</button>
          <button class="toggle-btn" id="agg-monthly">Monthly</button>
        </div>
        <span class="text-sm font-semibold" style="color: var(--color-muted);" id="breakdown-label">-</span>
        <button class="btn-ghost btn-mini" id="export-breakdown" type="button" title="Export Time Breakdown to CSV">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v12m0 0l-3-3m3 3l3-3M4 17v2a2 2 0 002 2h12a2 2 0 002-2v-2"></path>
          </svg>
          Export CSV
        </button>
      </div>
     </div>
     <div class="overflow-x-auto">
      <table class="data-table" id="breakdown-table">
       <thead>
        <tr>
         <th>Period</th>
         <th>Tested</th>
         <th>Passed</th>
         <th>Bonepile</th>
         <th>Fresh</th>
         <th>Pass Rate</th>
        </tr>
       </thead>
       <tbody id="breakdown-tbody">
        <tr>
         <td colspan="6" style="color: var(--color-muted);">No data yet. Apply a filter to load.</td>
        </tr>
       </tbody>
      </table>
     </div>
    </div>

    <!-- Test Flow Panel -->
    <div class="panel card mb-8 animate-in delay-4" id="test-flow-panel">
      <div class="card-header">
        <div class="card-header-row">
          <div>
            <h2 style="margin: 0; font-size: 1.25rem; font-weight: 600; color: var(--color-text);">Test Flow Analysis</h2>
            <p style="margin: 0.5rem 0 0 0; font-size: 0.875rem; color: var(--color-muted);">Station-by-station test results breakdown</p>
          </div>
          <div style="display:flex; flex-direction:column; align-items:flex-end; gap:0.35rem;">
            <div class="tf-legend" aria-label="Test Flow legend">
              <span style="font-weight: 700;">Cell:</span>
              <span class="demo-pill" title="Cell value format">
                <span class="pass-count">PASS</span><span class="slash">/</span><span class="fail-count">FAIL</span>
              </span>
            </div>
            <div class="tf-range" id="range-note-flow">-</div>
            <button class="btn-ghost btn-mini" id="export-flow" type="button" title="Export Test Flow to CSV">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v12m0 0l-3-3m3 3l3-3M4 17v2a2 2 0 002 2h12a2 2 0 002-2v-2"></path>
              </svg>
              Export CSV
            </button>
          </div>
        </div>
      </div>
      <div class="table-container">
        <table id="test-flow-table">
          <thead>
            <tr id="test-flow-head-row">
              <th style="min-width: 100px;">TS</th>
              <th style="min-width: 120px;">SKU</th>
              <!-- Station columns will be dynamically inserted here -->
            </tr>
          </thead>
          <tbody id="test-flow-tbody">
            <tr>
              <td colspan="100" style="text-align: center; padding: 3rem; color: var(--color-muted);">
                <div style="display: flex; flex-direction: column; align-items: center; gap: 0.75rem;">
                  <svg width="48" height="48" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="opacity: 0.5;">
                    <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                    <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                    <line x1="12" y1="22.08" x2="12" y2="12"></line>
                  </svg>
                  <span style="font-weight: 500;">No test flow data available</span>
                  <span style="font-size: 0.875rem;">Apply filters to load station results</span>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- NV Disposition section (loads independently, shown when ready) -->
    <div class="dispo-section-divider" style="margin-top: 2.5rem; margin-bottom: 1.5rem; border-top: 2px solid var(--color-border); padding-top: 1.5rem;"></div>
    <div class="panel" id="dispo-section" style="display: none;">
      <div class="flex items-center justify-between gap-4 mb-4">
        <h2 class="text-lg font-bold" style="color: var(--color-text);">NV Disposition</h2>
        <div class="flex items-center gap-2">
          <span class="text-sm" style="color: var(--color-muted);">Loading…</span>
        </div>
      </div>
      <div id="dispo-content" style="display: none;">
        <!-- Summary Overview (KPI Cards style) -->
        <h2 class="text-2xl font-bold mb-6 animate-in delay-2" style="color: var(--color-text);">NV Disposition Summary</h2>
        <div class="panel mb-8 animate-in delay-2">
          <div class="flex items-center justify-between mb-5">
            <h3 class="text-lg font-semibold" style="color: var(--color-text);">Disposition Overview</h3>
            <div class="flex items-center gap-3">
              <span class="text-sm font-semibold" style="color: var(--color-muted);" id="range-note-dispo">-</span>
              <button class="btn-ghost btn-mini" id="export-dispo-summary" type="button" title="Export Disposition Summary to CSV">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v12m0 0l-3-3m3 3l3-3M4 17v2a2 2 0 002 2h12a2 2 0 002-2v-2"></path>
                </svg>
                Export CSV
              </button>
            </div>
          </div>
          <div class="kpi-grid mb-4">
            <div class="kpi-card">
              <div class="kpi-label">Total Dispositions</div>
              <div class="kpi-value">
                <div id="dispo-sum-total" class="text-3xl font-extrabold" style="color: var(--color-text);">-</div>
                <button class="metric-btn" id="dispo-sum-total-btn" data-dispo-metric="total" data-dispo-segment="summary">View</button>
              </div>
            </div>
            <div class="kpi-card">
              <div class="kpi-label">Waiting IGS</div>
              <div class="kpi-value">
                <div id="dispo-sum-waiting" class="text-3xl font-extrabold" style="color: var(--color-text);">-</div>
                <button class="metric-btn" id="dispo-sum-waiting-btn" data-dispo-metric="waiting_igs" data-dispo-segment="summary">View</button>
              </div>
            </div>
            <div class="kpi-card">
              <div class="kpi-label">Complete</div>
              <div class="kpi-value">
                <div id="dispo-sum-complete" class="text-3xl font-extrabold" style="color: var(--color-text);">-</div>
                <button class="metric-btn" id="dispo-sum-complete-btn" data-dispo-metric="complete" data-dispo-segment="summary">View</button>
              </div>
            </div>
            <div class="kpi-card">
              <div class="kpi-label">Unique Trays in BP</div>
              <div class="kpi-value">
                <div id="dispo-sum-trays-bp" class="text-3xl font-extrabold" style="color: var(--color-text);">-</div>
                <button class="metric-btn" id="dispo-sum-trays-bp-btn" data-dispo-metric="trays_bp" data-dispo-segment="summary">View</button>
              </div>
            </div>
            <div class="kpi-card">
              <div class="kpi-label">All Pass Trays</div>
              <div class="kpi-value">
                <div id="dispo-sum-all-pass" class="text-3xl font-extrabold" style="color: var(--color-text);">-</div>
                <button class="metric-btn" id="dispo-sum-all-pass-btn" data-dispo-metric="all_pass_trays" data-dispo-segment="summary">View</button>
              </div>
            </div>
          </div>
          <p class="text-xs mt-4" style="color: var(--color-muted);">
            <strong>Note:</strong> Only SNs with Status = Fail and PIC = IGS. 
            Waiting = IGS Action empty or last IGS date &lt; last NV Disposition date. 
            Complete = last IGS Action date &gt;= last NV Disposition date. 
            Total = Waiting + Complete.
          </p>
        </div>
        <!-- By SKU -->
        <div class="mb-6">
          <div class="flex items-center justify-between gap-3 mb-2">
            <div class="text-sm font-bold" style="color: var(--color-muted);">By SKU</div>
            <button class="btn-ghost btn-mini" id="export-dispo-by-sku-excel" type="button" title="Export By SKU to Excel">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v12m0 0l-3-3m3 3l3-3M4 17v2a2 2 0 002 2h12a2 2 0 002-2v-2"></path>
              </svg>
              Export to Excel
            </button>
          </div>
          <div class="table-container">
            <table class="data-table" id="dispo-sku-table">
              <thead>
                <tr>
                  <th>SKU</th>
                  <th>Total</th>
                  <th>Waiting IGS</th>
                  <th>Complete</th>
                </tr>
              </thead>
              <tbody id="dispo-sku-tbody"></tbody>
            </table>
          </div>
        </div>
        <!-- Tray Breakdown by SKU -->
        <div class="mb-6">
          <div class="text-sm font-bold mb-2" style="color: var(--color-muted);">Tray Breakdown by SKU</div>
          <div class="table-container">
            <table class="data-table" id="dispo-tray-sku-table">
              <thead>
                <tr>
                  <th>SKU</th>
                  <th>Total Trays in BP</th>
                  <th>All Pass Trays</th>
                </tr>
              </thead>
              <tbody id="dispo-tray-sku-tbody"></tbody>
            </table>
          </div>
        </div>
        <!-- By period (Daily / Weekly / Monthly) - based on filter date range, period from mm/dd in disposition/IGS action -->
        <div class="mb-6">
          <div class="flex items-center justify-between gap-4 mb-2 flex-wrap">
            <div class="text-sm font-bold" style="color: var(--color-muted);">By period</div>
            <div class="flex items-center gap-3 flex-wrap">
              <span class="text-sm font-semibold" style="color: var(--color-muted);" id="range-note-dispo-period">-</span>
              <div class="flex gap-2">
                <button type="button" class="bp-mini dispo-agg-btn active" data-dispo-agg="daily">Daily</button>
                <button type="button" class="bp-mini dispo-agg-btn" data-dispo-agg="weekly">Weekly</button>
                <button type="button" class="bp-mini dispo-agg-btn" data-dispo-agg="monthly">Monthly</button>
              </div>
            </div>
          </div>
          <p class="text-xs mb-2" style="color: var(--color-muted);">Period is derived from the last mm/dd in NV Disposition or IGS Action; only periods within the filter range are shown.</p>
          <div class="table-container">
            <table class="data-table" id="dispo-period-table">
              <thead>
                <tr>
                  <th>Period</th>
                  <th>Total</th>
                  <th>Waiting IGS</th>
                  <th>Complete</th>
                </tr>
              </thead>
              <tbody id="dispo-period-tbody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
   </main>
  </div><!-- Loading overlay -->
  <div class="api-status ok" id="api-status" aria-live="polite" aria-atomic="true">
    <span class="dot" aria-hidden="true"></span>
    <span class="text" id="api-status-text">Ready</span>
  </div>
  <div class="loading-overlay" id="loading-overlay">
   <div class="panel" style="background: rgba(15, 23, 42, 0.95); border-color: rgba(99, 102, 241, 0.3); color: white; max-width: 520px;">
    <div class="flex items-center gap-4">
     <div class="spinner"></div>
     <div>
      <div class="text-lg font-bold">
       Scanning…
      </div>
      <div class="text-sm mt-1" style="color: rgba(255,255,255,0.8);" id="loading-text">
       Preparing scan job
      </div>
     </div>
    </div>
   </div>
  </div><!-- Upload Modal -->
  <div class="modal-overlay" id="upload-modal">
   <div class="modal-content">
    <div class="flex items-center justify-between mb-6">
     <h3 class="text-xl font-bold" style="color: var(--color-text);">Upload File</h3><button class="w-9 h-9 rounded-lg flex items-center justify-center transition-colors" style="background: var(--color-bg);" id="close-modal">
      <svg class="w-5 h-5" style="color: var(--color-muted);" fill="none" stroke="currentColor" viewbox="0 0 24 24">
       <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
      </svg></button>
    </div>
    <div class="border-2 border-dashed rounded-xl p-8 text-center transition-colors" style="border-color: var(--color-border); background: var(--color-bg);" id="drop-zone">
     <svg class="w-12 h-12 mx-auto mb-4" style="color: var(--color-primary);" fill="none" stroke="currentColor" viewbox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
     </svg>
     <p class="font-semibold mb-2" style="color: var(--color-text);">Drag &amp; drop your file here</p>
     <p class="text-sm mb-4" style="color: var(--color-muted);">or click to browse</p><input type="file" id="file-input" class="hidden" accept=".xlsx"> <button class="btn-primary" id="browse-btn" type="button">Browse XLSX</button>
    </div>
    <p class="text-xs mt-4 text-center" style="color: var(--color-muted);">Upload the NV/IGS workbook (.xlsx). The server will replace the previous file.</p>

    <div class="mt-6" id="bonepile-panel">
      <div class="bp-card">
        <div class="flex items-center justify-between gap-4">
          <div>
            <div class="text-sm font-bold" style="color: var(--color-text);">Bonepile workbook status</div>
            <div class="text-xs mt-1" style="color: var(--color-muted);" id="bp-file-line">No file uploaded yet.</div>
          </div>
          <div class="flex items-center gap-2">
            <span class="bp-badge" id="bp-parse-badge">Idle</span>
            <button class="bp-mini" id="bp-refresh" type="button">Refresh</button>
            <button class="bp-mini" id="bp-clear-cache" type="button" style="background: var(--color-danger); color: white;">Clear Cache</button>
          </div>
        </div>
        <div class="mt-3 text-xs" style="color: var(--color-muted);" id="bp-ignored-line"></div>
      </div>

      <div class="mt-4 bp-card">
        <div class="flex items-center justify-between gap-4 mb-3">
          <div>
            <div class="text-sm font-bold" style="color: var(--color-text);">Sheet mapping (optional)</div>
            <div class="text-xs mt-1" style="color: var(--color-muted);">
              Backend will auto-detect header by <b>SN</b> and auto-map columns by header name. Use mapping only if auto-detect fails.
            </div>
          </div>
          <div class="bp-actions" style="margin-top:0;">
            <button class="bp-mini" id="bp-parse-all" type="button">Parse All Sheets</button>
          </div>
        </div>

        <div id="bp-sheets"></div>
      </div>
    </div>
   </div>
  </div>

  <!-- SN Drilldown Modal -->
  <div class="modal-overlay" id="sn-modal">
    <div class="modal-content" style="max-width: 1100px;">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h3 id="sn-modal-title" class="text-xl font-bold" style="color: var(--color-text);">SN List</h3>
          <div id="sn-modal-subtitle" class="text-sm mt-1" style="color: var(--color-muted);">-</div>
        </div>
        <button class="w-9 h-9 rounded-lg flex items-center justify-center transition-colors" style="background: var(--color-bg);" id="close-sn-modal" title="Close">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <div class="overflow-x-auto" style="max-height: 70vh; overflow-y: auto;">
        <table class="data-table">
          <thead>
            <tr>
              <th>SN</th>
              <th>Result</th>
              <th>Part Number</th>
              <th>Last Station</th>
              <th>Test Time</th>
              <th>BP</th>
              <th id="sn-modal-failure-th" style="display:none;">Failure Msg</th>
            </tr>
          </thead>
          <tbody id="sn-modal-tbody">
            <tr><td colspan="6" style="color: var(--color-muted);">No data</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Disposition SN Modal (SN, Last NV Dispo, Last IGS Action) -->
  <div class="modal-overlay" id="dispo-sn-modal">
    <div class="modal-content" style="max-width: 1100px;">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h3 id="dispo-sn-modal-title" class="text-xl font-bold" style="color: var(--color-text);">NV Disposition – SN List</h3>
          <div id="dispo-sn-modal-subtitle" class="text-sm mt-1" style="color: var(--color-muted);">-</div>
        </div>
        <button class="w-9 h-9 rounded-lg flex items-center justify-center transition-colors" style="background: var(--color-bg);" id="close-dispo-sn-modal" title="Close">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <div class="overflow-x-auto" style="max-height: 70vh; overflow-y: auto;">
        <table class="data-table">
          <thead>
            <tr>
              <th>SN</th>
              <th>SKU</th>
              <th>Status</th>
              <th>PIC</th>
              <th>Last NV Dispo</th>
              <th>Last IGS Action</th>
            </tr>
          </thead>
          <tbody id="dispo-sn-modal-tbody">
            <tr><td colspan="6" style="color: var(--color-muted);">No data</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
  <script>
   const defaultConfig = {
     dashboard_title: 'Analytics Dashboard',
     summary_title: 'Summary Overview',
     primary_color: '#6366F1',
     surface_color: '#FFFFFF',
     text_color: '#1E293B',
     background_color: '#F1F5F9',
     accent_color: '#10B981'
   };
   let config = { ...defaultConfig };

   // Theme
   let isDarkMode = false;
   function toggleTheme() {
     isDarkMode = !isDarkMode;
     document.documentElement.classList.toggle('dark', isDarkMode);
     document.getElementById('sun-icon').classList.toggle('hidden', !isDarkMode);
     document.getElementById('moon-icon').classList.toggle('hidden', isDarkMode);
   }

   // Modal handling
   function openModal() {
     document.getElementById('upload-modal').classList.add('active');
     refreshBonepilePanel().catch(() => {});
   }
   function closeModal() { document.getElementById('upload-modal').classList.remove('active'); }

   function openSnModal() { document.getElementById('sn-modal').classList.add('active'); }
   function closeSnModal() { document.getElementById('sn-modal').classList.remove('active'); }

   function openDispoSnModal() { document.getElementById('dispo-sn-modal').classList.add('active'); }
   function closeDispoSnModal() { document.getElementById('dispo-sn-modal').classList.remove('active'); }

   // Loading overlay
   function setLoading(active, text) {
     const el = document.getElementById('loading-overlay');
     const t = document.getElementById('loading-text');
     if (t && text) t.textContent = text;
     el.classList.toggle('active', !!active);
   }

  // Sticky API status (bottom-left)
  function setApiStatus(message, level = 'ok') {
    const box = document.getElementById('api-status');
    const text = document.getElementById('api-status-text');
    if (!box || !text) return;
    text.textContent = message || 'Ready';
    box.classList.remove('ok', 'busy', 'warn', 'err');
    box.classList.add(level);
  }

   // Aggregation toggle
   let aggregation = 'daily';
   function setAgg(a) {
     aggregation = a;
     document.getElementById('agg-daily').classList.toggle('active', a === 'daily');
     document.getElementById('agg-weekly').classList.toggle('active', a === 'weekly');
     document.getElementById('agg-monthly').classList.toggle('active', a === 'monthly');
    updateRangeNotes();
   }

   // NV Disposition (loads independently)
   let dispoAggregation = 'daily';
   let lastDispoData = null;

   async function loadDispositionPanel() {
     const section = document.getElementById('dispo-section');
     const content = document.getElementById('dispo-content');
     if (!section || !content) return;
     section.style.display = 'block';
     content.style.display = 'none';
     const header = section.querySelector('.flex.items-center.justify-between span');
     if (header) header.textContent = 'Loading…';
     try {
       const payload = getRangePayload();
       const params = new URLSearchParams({
         aggregation: dispoAggregation,
         start_datetime: payload.start_datetime,
         end_datetime: payload.end_datetime
       });
       const res = await fetch('/api/bonepile/disposition?' + params.toString());
       const data = await res.json();
       if (data.error) throw new Error(data.error);
       lastDispoData = data;
       if (header) header.textContent = '';
       content.style.display = 'block';
       renderDispositionSummary(data.summary || {});
       renderDispositionBySku(data.by_sku || []);
       renderDispositionByPeriod(data.by_period || []);
       renderDispositionTrayBySku(data.tray_by_sku || []);
     } catch (e) {
       if (header) header.textContent = 'Error: ' + (e.message || e);
     }
   }

   function renderDispositionSummary(summary) {
     const total = summary.total ?? 0;
     const waiting = summary.waiting_igs ?? 0;
     const complete = summary.complete ?? 0;
     const uniqueTraysBp = summary.unique_trays_bp ?? 0;
     const allPassTrays = summary.all_pass_trays ?? 0;
     
     // Update KPI card values
     const setValue = (id, val) => {
       const el = document.getElementById(id);
       if (el) el.textContent = (val === null || val === undefined) ? '-' : val;
     };
     setValue('dispo-sum-total', total);
     setValue('dispo-sum-waiting', waiting);
     setValue('dispo-sum-complete', complete);
     setValue('dispo-sum-trays-bp', uniqueTraysBp);
     setValue('dispo-sum-all-pass', allPassTrays);
     
     // Update View buttons
     const setBtn = (id, val, metric) => {
       const el = document.getElementById(id);
       if (!el) return;
       el.disabled = (val === 0 || val === '-' || val === null || val === undefined);
       el.setAttribute('data-dispo-metric', metric);
     };
     setBtn('dispo-sum-total-btn', total, 'total');
     setBtn('dispo-sum-waiting-btn', waiting, 'waiting_igs');
     setBtn('dispo-sum-complete-btn', complete, 'complete');
     setBtn('dispo-sum-trays-bp-btn', uniqueTraysBp, 'trays_bp');
     setBtn('dispo-sum-all-pass-btn', allPassTrays, 'all_pass_trays');
     
     // Update range notes (Summary and By period)
     const payload = getRangePayload();
     const rangeEl = document.getElementById('range-note-dispo');
     if (rangeEl) rangeEl.textContent = `${payload.start_datetime} → ${payload.end_datetime} (CA)`;
     const rangePeriodEl = document.getElementById('range-note-dispo-period');
     if (rangePeriodEl) rangePeriodEl.textContent = `${payload.start_datetime} → ${payload.end_datetime} (CA)`;
   }

   function renderDispositionBySku(rows) {
     const tbody = document.getElementById('dispo-sku-tbody');
     if (!tbody) return;
     if (!rows || !rows.length) {
       tbody.innerHTML = '<tr><td colspan="4" style="color: var(--color-muted);">No data</td></tr>';
       return;
     }
     let totalTotal = 0, totalWaiting = 0, totalComplete = 0;
     const rowsHtml = rows.map(r => {
       const total = r.total ?? 0;
       const waiting = r.waiting_igs ?? 0;
       const complete = r.complete ?? 0;
       totalTotal += total;
       totalWaiting += waiting;
       totalComplete += complete;
       const sku = (r.sku || 'Unknown').replace(/</g, '&lt;').replace(/"/g, '&quot;');
       return `<tr>
         <td class="font-mono font-semibold">${sku}</td>
         <td><button type="button" class="metric-btn" data-dispo-metric="total" data-dispo-segment="sku" data-dispo-sku="${sku}" ${total === 0 ? 'disabled' : ''}>${total}</button></td>
         <td><button type="button" class="metric-btn" data-dispo-metric="waiting_igs" data-dispo-segment="sku" data-dispo-sku="${sku}" ${waiting === 0 ? 'disabled' : ''}>${waiting}</button></td>
         <td><button type="button" class="metric-btn" data-dispo-metric="complete" data-dispo-segment="sku" data-dispo-sku="${sku}" ${complete === 0 ? 'disabled' : ''}>${complete}</button></td>
       </tr>`;
     }).join('');
     const totalRow = `<tr style="background: var(--color-bg); font-weight: bold;">
       <td class="font-mono font-semibold">TOTAL</td>
       <td><button type="button" class="metric-btn" data-dispo-metric="total" data-dispo-segment="sku" data-dispo-sku="__TOTAL__" ${totalTotal === 0 ? 'disabled' : ''}>${totalTotal}</button></td>
       <td><button type="button" class="metric-btn" data-dispo-metric="waiting_igs" data-dispo-segment="sku" data-dispo-sku="__TOTAL__" ${totalWaiting === 0 ? 'disabled' : ''}>${totalWaiting}</button></td>
       <td><button type="button" class="metric-btn" data-dispo-metric="complete" data-dispo-segment="sku" data-dispo-sku="__TOTAL__" ${totalComplete === 0 ? 'disabled' : ''}>${totalComplete}</button></td>
     </tr>`;
     tbody.innerHTML = rowsHtml + totalRow;
   }

   function renderDispositionByPeriod(rows) {
     const tbody = document.getElementById('dispo-period-tbody');
     if (!tbody) return;
     if (!rows || !rows.length) {
       tbody.innerHTML = '<tr><td colspan="4" style="color: var(--color-muted);">No data</td></tr>';
       return;
     }
     let totalTotal = 0, totalWaiting = 0, totalComplete = 0;
     const rowsHtml = rows.map(r => {
       const total = r.total ?? 0;
       const waiting = r.waiting_igs ?? 0;
       const complete = r.complete ?? 0;
       totalTotal += total;
       totalWaiting += waiting;
       totalComplete += complete;
       const period = (r.period || '').replace(/</g, '&lt;').replace(/"/g, '&quot;');
       return `<tr>
         <td class="font-mono font-semibold">${period}</td>
         <td><button type="button" class="metric-btn" data-dispo-metric="total" data-dispo-segment="period" data-dispo-period="${period}" ${total === 0 ? 'disabled' : ''}>${total}</button></td>
         <td><button type="button" class="metric-btn" data-dispo-metric="waiting_igs" data-dispo-segment="period" data-dispo-period="${period}" ${waiting === 0 ? 'disabled' : ''}>${waiting}</button></td>
         <td><button type="button" class="metric-btn" data-dispo-metric="complete" data-dispo-segment="period" data-dispo-period="${period}" ${complete === 0 ? 'disabled' : ''}>${complete}</button></td>
       </tr>`;
     }).join('');
     const totalRow = `<tr style="background: var(--color-bg); font-weight: bold;">
       <td class="font-mono font-semibold">TOTAL</td>
       <td><button type="button" class="metric-btn" data-dispo-metric="total" data-dispo-segment="period" data-dispo-period="__TOTAL__" ${totalTotal === 0 ? 'disabled' : ''}>${totalTotal}</button></td>
       <td><button type="button" class="metric-btn" data-dispo-metric="waiting_igs" data-dispo-segment="period" data-dispo-period="__TOTAL__" ${totalWaiting === 0 ? 'disabled' : ''}>${totalWaiting}</button></td>
       <td><button type="button" class="metric-btn" data-dispo-metric="complete" data-dispo-segment="period" data-dispo-period="__TOTAL__" ${totalComplete === 0 ? 'disabled' : ''}>${totalComplete}</button></td>
     </tr>`;
     tbody.innerHTML = rowsHtml + totalRow;
   }

   function renderDispositionTrayBySku(rows) {
     const tbody = document.getElementById('dispo-tray-sku-tbody');
     if (!tbody) return;
     if (!rows || !rows.length) {
       tbody.innerHTML = '<tr><td colspan="3" style="color: var(--color-muted);">No data</td></tr>';
       return;
     }
     let totalTrays = 0, totalAllPass = 0;
     const rowsHtml = rows.map(r => {
       const totalTraysBp = r.total_trays ?? 0;
       const allPassTrays = r.all_pass_trays ?? 0;
       totalTrays += totalTraysBp;
       totalAllPass += allPassTrays;
       const sku = (r.sku || 'Unknown').replace(/</g, '&lt;').replace(/"/g, '&quot;');
       return `<tr>
         <td class="font-mono font-semibold">${sku}</td>
         <td><button type="button" class="metric-btn" data-dispo-metric="trays_bp" data-dispo-segment="tray_sku" data-dispo-sku="${sku}" ${totalTraysBp === 0 ? 'disabled' : ''}>${totalTraysBp}</button></td>
         <td><button type="button" class="metric-btn" data-dispo-metric="all_pass_trays" data-dispo-segment="tray_sku" data-dispo-sku="${sku}" ${allPassTrays === 0 ? 'disabled' : ''}>${allPassTrays}</button></td>
       </tr>`;
     }).join('');
     const totalRow = `<tr style="background: var(--color-bg); font-weight: bold;">
       <td class="font-mono font-semibold">TOTAL</td>
       <td><button type="button" class="metric-btn" data-dispo-metric="trays_bp" data-dispo-segment="tray_sku" data-dispo-sku="__TOTAL__" ${totalTrays === 0 ? 'disabled' : ''}>${totalTrays}</button></td>
       <td><button type="button" class="metric-btn" data-dispo-metric="all_pass_trays" data-dispo-segment="tray_sku" data-dispo-sku="__TOTAL__" ${totalAllPass === 0 ? 'disabled' : ''}>${totalAllPass}</button></td>
     </tr>`;
     tbody.innerHTML = rowsHtml + totalRow;
   }

   async function loadDispositionSnList(metric, sku, period) {
     setApiStatus('Loading disposition SN list…', 'busy');
     setLoading(true, 'Loading SN list…');
     openDispoSnModal();
     const title = document.getElementById('dispo-sn-modal-title');
     const subtitle = document.getElementById('dispo-sn-modal-subtitle');
     const tbody = document.getElementById('dispo-sn-modal-tbody');
     title.textContent = 'NV Disposition – SN List';
     
     let metricLabel = 'Total';
     if (metric === 'waiting_igs') metricLabel = 'Waiting IGS';
     else if (metric === 'complete') metricLabel = 'Complete';
     else if (metric === 'trays_bp') metricLabel = 'Unique Trays in BP';
     else if (metric === 'all_pass_trays') metricLabel = 'All Pass Trays';
     
     subtitle.textContent = metricLabel + (sku && sku !== '__TOTAL__' ? ' • ' + sku : '') + (period && period !== '__TOTAL__' ? ' • ' + period : '');
     tbody.innerHTML = '<tr><td colspan="6" style="color: var(--color-muted);">Loading…</td></tr>';
     try {
       const payload = getRangePayload();
       const res = await fetch('/api/bonepile/disposition/sn-list', {
         method: 'POST',
         headers: { 'Content-Type': 'application/json' },
         body: JSON.stringify({ 
           metric: metric === 'waiting_igs' ? 'waiting' : metric, 
           sku: (sku && sku !== '__TOTAL__') ? sku : undefined, 
           period: (period && period !== '__TOTAL__') ? period : undefined, 
           aggregation: dispoAggregation,
           start_datetime: payload.start_datetime,
           end_datetime: payload.end_datetime
         })
       });
       const data = await res.json();
       if (data.error) throw new Error(data.error);
       const rows = data.rows || [];
       if (!rows.length) {
         tbody.innerHTML = '<tr><td colspan="6" style="color: var(--color-muted);">No data</td></tr>';
       } else {
         tbody.innerHTML = rows.map(r => {
           const sn = (r.sn || '').replace(/</g, '&lt;');
           const nvpn = (r.nvpn || '').replace(/</g, '&lt;');
           const status = (r.status || '').replace(/</g, '&lt;');
           const pic = (r.pic || '').replace(/</g, '&lt;');
           const lastNv = (r.last_nv_dispo || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
           const lastIgs = (r.last_igs_action || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
           return `<tr><td class="font-mono font-semibold">${sn}</td><td class="font-mono">${nvpn}</td><td>${status}</td><td>${pic}</td><td class="font-mono text-xs" style="max-width:280px;word-break:break-word;">${lastNv}</td><td class="font-mono text-xs" style="max-width:280px;word-break:break-word;">${lastIgs}</td></tr>`;
         }).join('');
       }
       subtitle.textContent = metricLabel + (sku && sku !== '__TOTAL__' ? ' • ' + sku : '') + (period && period !== '__TOTAL__' ? ' • ' + period : '') + ' • ' + (data.count || 0) + ' SN';
       setApiStatus('Ready', 'ok');
     } catch (e) {
       tbody.innerHTML = '<tr><td colspan="6" style="color: var(--color-danger);">' + (e.message || e) + '</td></tr>';
       setApiStatus('Error: ' + (e.message || e), 'err');
     }
     setLoading(false);
   }

   // Helpers
  const CA_TIME_ZONE = 'America/Los_Angeles';

  function fmtDateTimeCAFromMs(ms) {
    if (!ms) return 'unknown';
    const d = new Date(ms);
    return new Intl.DateTimeFormat('en-US', {
      timeZone: CA_TIME_ZONE,
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit',
    }).format(d);
  }

  function fmtDateCA(dateObj) {
    // Returns YYYY-MM-DD in CA timezone (stable, not affected by user PC timezone).
    const parts = new Intl.DateTimeFormat('en-CA', {
      timeZone: CA_TIME_ZONE,
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
    }).formatToParts(dateObj);
    const y = parts.find(p => p.type === 'year')?.value || '1970';
    const m = parts.find(p => p.type === 'month')?.value || '01';
    const d = parts.find(p => p.type === 'day')?.value || '01';
    return `${y}-${m}-${d}`;
  }

   function fmtPct(x) {
     if (x === null || x === undefined) return '-';
     return Math.round(x * 100) + '%';
   }

   function setText(id, value) {
     const el = document.getElementById(id);
     if (el) el.textContent = (value === null || value === undefined) ? '-' : value;
   }

   async function refreshCacheCoverage() {
     /* SFC data is fetched on demand; no cache coverage to refresh */
   }

   function _applyBonepileStatus(bp) {
     const line = document.getElementById('bp-file-line');
     const badge = document.getElementById('bp-parse-badge');
     if (!line || !badge) return;
     const file = (bp && bp.file) ? bp.file : {};
     const sheets = (bp && bp.sheets) ? bp.sheets : {};
     const has = !!file.has_file;
     if (!has) {
       line.textContent = 'No file uploaded yet.';
       badge.classList.remove('ok','err');
       badge.textContent = 'Idle';
       return;
     }
     const name = file.original_name || 'bonepile_upload.xlsx';
     const ts = file.uploaded_at_ca_ms ? fmtDateTimeCAFromMs(file.uploaded_at_ca_ms) : 'unknown';
     line.textContent = `${name} • uploaded ${ts} (CA)`;
     
     // Compute summary: count ok/error sheets and total rows
     let okCount = 0, errCount = 0, totalRows = 0;
     const sheetNames = Object.keys(sheets || {});
     sheetNames.forEach(k => {
       const s = sheets[k];
       if (!s || typeof s !== 'object') return;
       if (s.status === 'ok') {
         okCount++;
         totalRows += (s.rows || 0);
       } else if (s.status === 'error') {
         errCount++;
       }
     });
     
     badge.classList.remove('ok','err');
     if (errCount > 0) {
       badge.textContent = `✗ Errors (${errCount} sheet${errCount > 1 ? 's' : ''} failed)`;
       badge.classList.add('err');
     } else if (okCount > 0) {
       const sheetText = okCount === sheetNames.length ? 'All parsed' : `${okCount}/${sheetNames.length} parsed`;
       badge.textContent = `✓ ${sheetText} (${totalRows} rows)`;
       badge.classList.add('ok');
     } else {
       badge.textContent = 'Not parsed yet';
     }
   }

   function _pickHeader(headers, candidates) {
     const set = new Set((headers || []).map(h => String(h).toUpperCase()));
     for (const c of candidates) {
       if (set.has(String(c).toUpperCase())) return c;
     }
     // partial match fallback
     for (const h of (headers || [])) {
       const up = String(h).toUpperCase();
       for (const c of candidates) {
         if (up.includes(String(c).toUpperCase())) return h;
       }
     }
     return '';
   }

   function _renderBonepileSheets(data) {
     const wrap = document.getElementById('bp-sheets');
     const ignored = document.getElementById('bp-ignored-line');
     if (!wrap) return;
     if (ignored) {
       const ig = (data && data.ignored) ? data.ignored : [];
       ignored.textContent = ig.length ? (`Ignored sheets: ${ig.join(', ')}`) : '';
     }
     if (!data || !data.sheets) {
       wrap.innerHTML = `<div class="text-xs" style="color: var(--color-muted);">Upload a workbook to configure mapping.</div>`;
       return;
     }
     const sheets = data.sheets;
     const order = (data.allowed || Object.keys(sheets));
     wrap.innerHTML = order.map(sheet => {
       const info = sheets[sheet] || {};
       const present = !!info.present;
       const headers = info.headers || [];
       const saved = info.saved_mapping || null;
       const st = info.status || null;
       const headerRow = (saved && saved.header_row) ? saved.header_row : (info.header_row || '');

       const defaultCols = {
         sn: _pickHeader(headers, ['SN']),
         nv_disposition: _pickHeader(headers, ['NV DISPOSITION','NV DISPO']),
         status: _pickHeader(headers, ['STATUS']),
         pic: _pickHeader(headers, ['PIC']),
         igs_action: _pickHeader(headers, ['IGS ACTION']),
         igs_status: _pickHeader(headers, ['IGS STATUS']),
         nvpn: _pickHeader(headers, ['NVPN','PART NUMBER','SKU']),
       };
       const savedCols = (saved && saved.columns) ? saved.columns : {};
       const colValue = (k) => (savedCols && savedCols[k]) ? savedCols[k] : (defaultCols[k] || '');

       const skipped = st && st.skipped === true;
       const badge = skipped ? '' : (st && st.status === 'ok' ? 'ok' : (st && st.status === 'error' ? 'err' : ''));
       const badgeText = skipped
         ? `⏭ Skipped (unchanged)`
         : (st && st.status === 'ok' 
           ? `✓ Parsed: ${st.rows || 0} rows` 
           : (st && st.status === 'error' ? '✗ Error' : 'Not parsed'));

       const opts = (headers || []).map(h => `<option value="${String(h).replace(/"/g,'&quot;')}">${h}</option>`).join('');
       const errText = (info.auto_errors && info.auto_errors.length) ? info.auto_errors.join('; ') : '';
       const stErr = st && st.error ? st.error : '';
       const skipReason = st && st.skip_reason ? st.skip_reason : '';
       const msg = skipReason || stErr || errText;

       return `
         <div class="bp-card mb-3" data-sheet="${sheet}">
           <div class="flex items-center justify-between gap-4">
             <div>
               <div class="text-sm font-bold" style="color: var(--color-text);">${sheet} ${present ? '' : '<span class="text-xs" style="color: var(--color-muted);">(not found in file)</span>'}</div>
               <div class="text-xs mt-1" style="color: var(--color-muted);" id="bp-msg-${sheet}">${msg ? msg : ''}</div>
             </div>
             <span class="bp-badge ${badge}" id="bp-badge-${sheet}">${badgeText}</span>
           </div>

           <div class="mt-3 bp-grid" ${present ? '' : 'style="opacity:0.6; pointer-events:none;"'}>
             <div>
               <div class="bp-label">Header row (1-based)</div>
               <input class="bp-input" type="number" min="1" step="1" id="bp-header-${sheet}" value="${headerRow}">
             </div>
             <div>
               <div class="bp-label">SN</div>
               <select class="bp-select" id="bp-col-${sheet}-sn">
                 <option value=""></option>
                 ${opts}
               </select>
             </div>
             <div>
               <div class="bp-label">NV Disposition</div>
               <select class="bp-select" id="bp-col-${sheet}-nv_disposition">
                 <option value=""></option>
                 ${opts}
               </select>
             </div>
             <div>
               <div class="bp-label">Status</div>
               <select class="bp-select" id="bp-col-${sheet}-status">
                 <option value=""></option>
                 ${opts}
               </select>
             </div>
             <div>
               <div class="bp-label">PIC</div>
               <select class="bp-select" id="bp-col-${sheet}-pic">
                 <option value=""></option>
                 ${opts}
               </select>
             </div>
             <div>
               <div class="bp-label">IGS Action</div>
               <select class="bp-select" id="bp-col-${sheet}-igs_action">
                 <option value=""></option>
                 ${opts}
               </select>
             </div>
             <div>
               <div class="bp-label">IGS Status</div>
               <select class="bp-select" id="bp-col-${sheet}-igs_status">
                 <option value=""></option>
                 ${opts}
               </select>
             </div>
             <div>
               <div class="bp-label">NVPN (optional)</div>
               <select class="bp-select" id="bp-col-${sheet}-nvpn">
                 <option value=""></option>
                 ${opts}
               </select>
             </div>
           </div>

           <div class="bp-actions">
             <button class="bp-mini" type="button" data-bp-auto="${sheet}">Auto-detect</button>
             <button class="bp-mini" type="button" data-bp-save="${sheet}">Save mapping + Parse</button>
             <button class="bp-mini" type="button" data-bp-parse="${sheet}">Parse sheet</button>
           </div>
         </div>
       `;
     }).join('');

     // Set select defaults after DOM is built
     order.forEach(sheet => {
       const info = sheets[sheet] || {};
       if (!info.present) return;
       const headers = info.headers || [];
       const saved = info.saved_mapping || null;
       const savedCols = (saved && saved.columns) ? saved.columns : {};
       const setSel = (id, v) => { const el = document.getElementById(id); if (el && v) el.value = v; };
       const defaults = {
         sn: _pickHeader(headers, ['SN']),
         nv_disposition: _pickHeader(headers, ['NV DISPOSITION','NV DISPO']),
         status: _pickHeader(headers, ['STATUS']),
         pic: _pickHeader(headers, ['PIC']),
         igs_action: _pickHeader(headers, ['IGS ACTION']),
         igs_status: _pickHeader(headers, ['IGS STATUS']),
         nvpn: _pickHeader(headers, ['NVPN','PART NUMBER','SKU']),
       };
       Object.keys(defaults).forEach(k => {
         setSel(`bp-col-${sheet}-${k}`, savedCols[k] || defaults[k] || '');
       });
     });
   }

   async function refreshBonepilePanel() {
     try {
       const res = await fetch('/api/bonepile/status');
       const bp = await res.json();
       _applyBonepileStatus(bp);
     } catch (e) {}
     try {
       const res2 = await fetch('/api/bonepile/sheets');
       const data = await res2.json();
       if (data && data.error) throw new Error(data.error);
       _renderBonepileSheets(data);
     } catch (e) {
       const wrap = document.getElementById('bp-sheets');
       if (wrap) wrap.innerHTML = `<div class="text-xs" style="color: var(--color-muted);">Bonepile mapping unavailable: ${e.message || e}</div>`;
     }
   }

   async function pollBonepileJob(jobId) {
     for (let i = 0; i < 600; i++) {
       const res = await fetch(`/api/job/${encodeURIComponent(jobId)}`);
       const data = await res.json();
       setLoading(true, data.message || 'Parsing...');
       if (data.status === 'done') {
         await refreshBonepilePanel();
         // Disposition uses current filter after upload
         loadDispositionPanel().catch(err => { console.error('loadDispositionPanel after parse:', err); });
         // Get summary from refreshed status
         try {
           const statusRes = await fetch('/api/bonepile/status');
           const bp = await statusRes.json();
           const sheets = bp.sheets || {};
           let okCount = 0, totalRows = 0;
           Object.keys(sheets).forEach(k => {
             const s = sheets[k];
             if (s && s.status === 'ok') {
               okCount++;
               totalRows += (s.rows || 0);
             }
           });
           const summary = okCount > 0 ? ` (${okCount} sheet${okCount > 1 ? 's' : ''}, ${totalRows} rows)` : '';
           setApiStatus(`✓ Parse completed${summary}`, 'ok');
         } catch (e) {
           setApiStatus('✓ Parse completed', 'ok');
         }
         setLoading(false);
         return data;
       }
       if (data.status === 'error') {
         await refreshBonepilePanel();
         const errMsg = data.error || 'unknown error';
         setApiStatus(`✗ Parse error: ${errMsg}`, 'err');
         setLoading(false);
         throw new Error(errMsg);
       }
       await new Promise(r => setTimeout(r, 1000));
     }
     setLoading(false);
     setApiStatus('✗ Parse timeout', 'err');
     throw new Error('Parse timeout');
   }

   let isUploadingBonepile = false;
   async function uploadBonepileFile(file) {
     if (!file) return;
     if (isUploadingBonepile) {
       console.log('Upload already in progress, skipping duplicate call');
       return;
     }
     isUploadingBonepile = true;
     try {
       setApiStatus('Uploading workbook...', 'work');
       setLoading(true, 'Uploading workbook...');
       const fd = new FormData();
       fd.append('file', file);
       const res = await fetch('/api/bonepile/upload', { method: 'POST', body: fd });
       const text = await res.text();
       let data = {};
       try { data = text ? JSON.parse(text) : {}; } catch (_) {}
       if (!res.ok || data.error) throw new Error(data.error || text || 'Upload failed');
       
       if (data.job_id) {
         // Auto-parse all sheets (with auto-detect, hash check will skip unchanged sheets)
         setApiStatus('Auto-parsing all sheets with auto-detect...', 'work');
         await pollBonepileJob(data.job_id);
       } else {
         setLoading(false);
         setApiStatus('Upload completed.', 'ok');
         await refreshBonepilePanel();
         loadDispositionPanel().catch(err => { console.error('loadDispositionPanel after upload:', err); });
       }
     } finally {
       isUploadingBonepile = false;
       // Clear input to prevent re-trigger on same file selection
       const fi = document.getElementById('file-input');
       if (fi) fi.value = '';
     }
   }

   async function saveBonepileMapping(sheet) {
     const header = document.getElementById(`bp-header-${sheet}`)?.value;
     const payload = {
       sheet,
       header_row: Number(header || 0),
       columns: {
         sn: document.getElementById(`bp-col-${sheet}-sn`)?.value || '',
         nv_disposition: document.getElementById(`bp-col-${sheet}-nv_disposition`)?.value || '',
         status: document.getElementById(`bp-col-${sheet}-status`)?.value || '',
         pic: document.getElementById(`bp-col-${sheet}-pic`)?.value || '',
         igs_action: document.getElementById(`bp-col-${sheet}-igs_action`)?.value || '',
         igs_status: document.getElementById(`bp-col-${sheet}-igs_status`)?.value || '',
         nvpn: document.getElementById(`bp-col-${sheet}-nvpn`)?.value || '',
       }
     };
     setApiStatus(`Saving mapping for ${sheet}...`, 'work');
     const res = await fetch('/api/bonepile/mapping', {
       method: 'POST',
       headers: { 'Content-Type': 'application/json' },
       body: JSON.stringify(payload),
     });
     const out = await res.json();
     if (!res.ok || out.error) throw new Error(out.error || 'Save failed');
     if (out.job_id) {
       setLoading(true, 'Parsing...');
       await pollBonepileJob(out.job_id);
     } else {
       setApiStatus('Mapping saved.', 'ok');
       await refreshBonepilePanel();
     }
   }

   async function parseBonepile(sheet = null) {
     setApiStatus('Parsing workbook...', 'work');
     setLoading(true, 'Parsing...');
     const res = await fetch('/api/bonepile/parse', {
       method: 'POST',
       headers: { 'Content-Type': 'application/json' },
       body: JSON.stringify(sheet ? { sheet } : {}),
     });
     const out = await res.json();
     if (!res.ok || out.error) throw new Error(out.error || 'Parse failed');
     if (out.job_id) {
       await pollBonepileJob(out.job_id);
     } else {
       setLoading(false);
       setApiStatus('Parse started.', 'ok');
       await refreshBonepilePanel();
     }
   }

   function fmtCountdown(seconds) {
     const s = Math.max(0, Math.floor(seconds || 0));
     const mm = String(Math.floor(s / 60)).padStart(2, '0');
     const ss = String(s % 60).padStart(2, '0');
     return `${mm}:${ss}`;
   }

   function startCountdownLoop() {
     const el = document.getElementById('next-scan-countdown');
     if (!el) return;
     setInterval(() => {
       const nextMs = window.__nextAutoScanMs;
       if (!nextMs) {
         el.textContent = '--:--';
         return;
       }
       const remainingSec = (nextMs - Date.now()) / 1000;
       el.textContent = fmtCountdown(remainingSec);
     }, 1000);
   }

   function getRangePayload() {
     const startDate = document.getElementById('start-date').value;
     const endDate = document.getElementById('end-date').value;
    const startTime = document.getElementById('start-time').value || '00:00';
    const endTime = document.getElementById('end-time').value || '23:59';
     return {
      start_datetime: `${startDate} ${startTime}`,
      // Backend treats end minute as inclusive to :59 seconds.
      end_datetime: `${endDate} ${endTime}`,
       aggregation
     };
   }

   function setMetricCell(cellId, value, metric, segment) {
     const td = document.getElementById(cellId);
     if (!td) return;
     const v = (value === null || value === undefined) ? '-' : value;
     const disabled = (v === '-' || v === 0 || v === '0') ? 'disabled' : '';
     const seg = segment ? ` data-segment="${segment}"` : '';
     td.innerHTML = `<button class="metric-btn" ${disabled} data-metric="${metric}"${seg}>${v}</button>`;
   }

   function renderSummary(tray_summary, summary) {
     const ts = tray_summary || {};
     setMetricCell('m-tested-bp', ts.tested?.bp, 'tray_tested_bp', 'bp');
     setMetricCell('m-tested-fresh', ts.tested?.fresh, 'tray_tested_fresh', 'fresh');
     setMetricCell('m-tested-total', ts.tested?.total, 'tested', 'total');
     setMetricCell('m-pass-bp', ts.pass?.bp, 'tray_pass_bp', 'bp');
     setMetricCell('m-pass-fresh', ts.pass?.fresh, 'tray_pass_fresh', 'fresh');
     setMetricCell('m-pass-total', ts.pass?.total, 'pass', 'total');
     setMetricCell('m-fail-bp', ts.fail?.bp, 'tray_fail_bp', 'bp');
     setMetricCell('m-fail-fresh', ts.fail?.fresh, 'tray_fail_fresh', 'fresh');
     setMetricCell('m-fail-total', ts.fail?.total, 'fail', 'total');

     const s = summary || {};
     setText('kpi-tested', s.total);
     setText('kpi-pass', s.pass);
     setText('kpi-fail', s.fail);
   }

   function renderSkuRows(rows) {
     const tbody = document.getElementById('sku-tbody');
     if (!tbody) return;
     if (!rows || !rows.length) {
       tbody.innerHTML = `<tr><td colspan="4" style="color: var(--color-muted);">No data</td></tr>`;
       return;
     }
    tbody.innerHTML = rows.map(r => {
      const sku = (r.sku || 'Unknown');
      const tested = r.tested ?? 0;
      const pass = r.pass ?? 0;
      const fail = r.fail ?? 0;
      const dis = (v) => (v === 0 || v === '0') ? 'disabled' : '';
      return `
        <tr>
          <td class="font-mono font-semibold">${sku}</td>
          <td class="font-mono font-semibold"><button class="metric-btn" ${dis(tested)} data-sku="${sku}" data-metric="tested">${tested}</button></td>
          <td class="font-mono"><button class="metric-btn" ${dis(pass)} data-sku="${sku}" data-metric="pass">${pass}</button></td>
          <td class="font-mono"><button class="metric-btn" ${dis(fail)} data-sku="${sku}" data-metric="fail">${fail}</button></td>
        </tr>
      `;
    }).join('');
   }

   function renderBreakdown(rows) {
     const tbody = document.getElementById('breakdown-tbody');
     if (!tbody) return;
     if (!rows || !rows.length) {
       tbody.innerHTML = `<tr><td colspan="6" style="color: var(--color-muted);">No data</td></tr>`;
       return;
     }
    tbody.innerHTML = rows.map(r => {
      const p = r.period;
      const tested = r.tested ?? 0;
      const passed = r.passed ?? 0;
      const bonepile = r.bonepile ?? 0;
      const fresh = r.fresh ?? 0;
      const dis = (v) => (v === 0 || v === '0') ? 'disabled' : '';
      return `
        <tr>
          <td class="font-mono font-semibold">${p}</td>
          <td class="font-mono font-semibold"><button class="metric-btn" ${dis(tested)} data-period="${p}" data-metric="total">${tested}</button></td>
          <td class="font-mono"><button class="metric-btn" ${dis(passed)} data-period="${p}" data-metric="pass">${passed}</button></td>
          <td class="font-mono font-semibold"><button class="metric-btn" ${dis(bonepile)} data-period="${p}" data-metric="breakdown_bonepile">${bonepile}</button></td>
          <td class="font-mono font-semibold"><button class="metric-btn" ${dis(fresh)} data-period="${p}" data-metric="breakdown_fresh">${fresh}</button></td>
          <td><span class="status-badge ${((r.pass_rate || 0) >= 0.5) ? 'status-success' : 'status-warning'}">${fmtPct(r.pass_rate || 0)}</span></td>
        </tr>
      `;
    }).join('');
   }

  function renderTestFlow(flow) {
    const headRow = document.getElementById('test-flow-head-row');
    const tbody = document.getElementById('test-flow-tbody');
    if (!headRow || !tbody) return;
    if (!flow || !flow.stations || !flow.stations.length) {
      tbody.innerHTML = `
        <tr>
          <td colspan="100" style="text-align: center; padding: 3rem; color: var(--color-muted);">
            <div style="display: flex; flex-direction: column; align-items: center; gap: 0.75rem;">
              <svg width="48" height="48" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="opacity: 0.5;">
                <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                <line x1="12" y1="22.08" x2="12" y2="12"></line>
              </svg>
              <span style="font-weight: 500;">No test flow data available</span>
              <span style="font-size: 0.875rem;">Apply filters to load station results</span>
            </div>
          </td>
        </tr>
      `;
      return;
    }
    const stations = flow.stations;
    headRow.innerHTML =
      `<th style="min-width: 100px;">TS</th><th style="min-width: 120px;">SKU</th>` +
      stations.map(s => `<th>${s}</th>`).join('');

    const mkCell = ({sku, station, pass, fail}) => {
      const p = pass ?? 0;
      const f = fail ?? 0;
      if (p === 0 && f === 0) return `<td data-station-cell></td>`;
      const disabled = (p === 0 && f === 0) ? 'disabled' : '';
      return `
        <td data-station-cell>
          <button class="metric-btn" data-flow="1" data-station="${station}" data-sku="${sku || ''}" ${disabled}>
            <span class="pass-count">${p}</span><span class="slash">/</span><span class="fail-count">${f}</span>
          </button>
        </td>
      `;
    };

    const totalRow = `
      <tr>
        <td class="font-bold">-</td>
        <td class="font-bold">TOTAL</td>
        ${stations.map(st => mkCell({sku: '', station: st, pass: flow.totals?.[st]?.pass ?? 0, fail: flow.totals?.[st]?.fail ?? 0})).join('')}
      </tr>
    `;

    const rowsHtml = (flow.rows || []).map(r => {
      return `
        <tr>
          <td class="font-mono font-semibold">${r.ts}</td>
          <td class="font-mono font-semibold">${r.sku}</td>
          ${stations.map(st => mkCell({sku: r.sku, station: st, pass: r.stations?.[st]?.pass ?? 0, fail: r.stations?.[st]?.fail ?? 0})).join('')}
        </tr>
      `;
    }).join('');

    tbody.innerHTML = totalRow + rowsHtml;
  }

  function updateRangeNotes() {
    const p = getRangePayload();
    const rangeText = `${p.start_datetime} → ${p.end_datetime} (CA)`;
    const set = (id, txt) => {
      const el = document.getElementById(id);
      if (el) el.textContent = txt;
    };
    set('range-note-summary', rangeText);
    set('range-note-sku', rangeText);
    set('range-note-flow', rangeText);
    // Time breakdown shows current range next to the toggle.
    set('breakdown-label', rangeText);
  }

  function _filenameFromDisposition(cd) {
    if (!cd) return null;
    const m = /filename=\"?([^\";]+)\"?/i.exec(cd);
    return m ? m[1] : null;
  }

  async function downloadCsv(exportKind) {
    const payload = getRangePayload();
    setLoading(true, 'Preparing export...');
    setApiStatus(`Exporting ${exportKind || 'csv'}...`, 'busy');
    const res = await fetch('/api/export', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ ...payload, aggregation, export: exportKind })
    });
    if (!res.ok) {
      let msg = `export failed (${res.status})`;
      try {
        const j = await res.json();
        if (j && j.error) msg = j.error;
      } catch (e) {}
      setLoading(false);
      setApiStatus(msg, 'err');
      throw new Error(msg);
    }
    const blob = await res.blob();
    const cd = res.headers.get('content-disposition');
    const filename = _filenameFromDisposition(cd) || `${exportKind || 'export'}.csv`;
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(() => URL.revokeObjectURL(url), 2500);
    setApiStatus('Download started', 'ok');
    setLoading(false);
  }

  async function downloadExcel(exportKind) {
    const payload = getRangePayload();
    setLoading(true, 'Preparing Excel export...');
    setApiStatus(`Exporting ${exportKind} to Excel...`, 'busy');
    const res = await fetch('/api/export', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ ...payload, aggregation, export: exportKind, format: 'xlsx' })
    });
    if (!res.ok) {
      let msg = `export failed (${res.status})`;
      try {
        const j = await res.json();
        if (j && j.error) msg = j.error;
      } catch (e) {}
      setLoading(false);
      setApiStatus(msg, 'err');
      throw new Error(msg);
    }
    const blob = await res.blob();
    const cd = res.headers.get('content-disposition');
    const filename = _filenameFromDisposition(cd) || `${exportKind}_export.xlsx`;
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(() => URL.revokeObjectURL(url), 2500);
    setApiStatus('Download started', 'ok');
    setLoading(false);
  }

   async function pollJob(jobId) {
     for (let i = 0; i < 600; i++) {
       const res = await fetch(`/api/job/${encodeURIComponent(jobId)}`);
       const data = await res.json();
       if (data.status === 'done') return data;
       if (data.status === 'error') throw new Error(data.error || 'scan error');
       setLoading(true, data.message || 'Scanning...');
       await new Promise(r => setTimeout(r, 1000));
     }
     throw new Error('scan timeout');
   }

   async function runQuery() {
     let payload = getRangePayload();
     if (!payload.start_datetime || !payload.end_datetime) {
       const startEl = document.getElementById('start-date');
       const endEl = document.getElementById('end-date');
       const now = new Date();
       if (startEl) startEl.value = fmtDateCA(now);
       if (endEl) endEl.value = fmtDateCA(now);
       payload = getRangePayload();
     }

     setLoading(true, 'Loading data from SFC...');
     setApiStatus('Querying SFC...', 'busy');
     const res = await fetch('/api/query', {
       method: 'POST',
       headers: { 'Content-Type': 'application/json' },
       body: JSON.stringify(payload)
     });
     let data;
     try {
       data = await res.json();
     } catch (e) {
       throw new Error(res.status ? `Server error ${res.status}` : 'Network or invalid response');
     }
     if (!res.ok) {
       throw new Error(data && data.error ? data.error : (res.statusText || `Error ${res.status}`));
     }
     if (data.error) throw new Error(data.error);

     renderSummary(data.tray_summary, data.summary);
     renderSkuRows(data.sku_rows);
     renderBreakdown(data.breakdown_rows);
     renderTestFlow(data.test_flow);
     setApiStatus('Ready', 'ok');
     setLoading(false);
   }

   function fmtMaybe(ms) {
     if (!ms) return '-';
     return fmtDateTimeCAFromMs(ms);
   }

   function renderTestFlowSnModal(passRows, failRows) {
     const tbody = document.getElementById('sn-modal-tbody');
     const thFailure = document.getElementById('sn-modal-failure-th');
     if (!tbody) return;
     if (thFailure) thFailure.style.display = '';
     const renderBlock = (label, rows, badgeClass, showFailureMsg) => {
       if (!rows || !rows.length) return '';
       const esc = (s) => (s || '').replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
       const failCell = (r) => showFailureMsg
         ? `<td class="text-left text-sm" style="max-width: 320px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${esc(r.last_failure_msg)}">${esc(r.last_failure_msg || '-')}</td>`
         : `<td></td>`;
       return `
         <tr><td colspan="7" class="font-bold pt-4 pb-1" style="color: var(--color-muted);">${label} (${rows.length})</td></tr>
         ${rows.map(r => {
           const result = (r.status || r.result || '-').toUpperCase();
           const bp = r.is_bonepile ? 'Yes' : 'No';
           return `<tr>
             <td class="font-mono font-semibold">${r.sn}</td>
             <td><span class="status-badge ${badgeClass}">${result}</span></td>
             <td class="font-mono font-semibold">${(r.part_number || r.last_part_number || 'Unknown')}</td>
             <td class="font-mono">${(r.last_station || '-')}</td>
             <td class="font-mono">${(r.last_test_time || fmtMaybe(r.pass_ca_ms) || '-')}</td>
             <td class="font-mono">${bp}</td>
             ${failCell(r)}
           </tr>`;
         }).join('')}
       `;
     };
     const html = renderBlock('Pass', passRows, 'status-success', false) + renderBlock('Fail', failRows, 'status-danger', true);
     tbody.innerHTML = html || `<tr><td colspan="7" style="color: var(--color-muted);">No data</td></tr>`;
   }

   function renderSnModalRows(rows) {
     const tbody = document.getElementById('sn-modal-tbody');
     const thFailure = document.getElementById('sn-modal-failure-th');
     if (!tbody) return;
     if (thFailure) thFailure.style.display = 'none';
     if (!rows || !rows.length) {
       tbody.innerHTML = `<tr><td colspan="6" style="color: var(--color-muted);">No data</td></tr>`;
       return;
     }
     tbody.innerHTML = rows.map(r => {
       const result = (r.status || r.result || '-').toUpperCase();
       const badgeClass = (result === 'PASS') ? 'status-success' : 'status-danger';
       const bp = r.is_bonepile ? 'Yes' : 'No';
       return `
         <tr>
           <td class="font-mono font-semibold">${r.sn}</td>
           <td><span class="status-badge ${badgeClass}">${result}</span></td>
           <td class="font-mono font-semibold">${(r.part_number || r.last_part_number || 'Unknown')}</td>
           <td class="font-mono">${(r.last_station || '-')}</td>
           <td class="font-mono">${(r.last_test_time || fmtMaybe(r.pass_ca_ms) || '-')}</td>
           <td class="font-mono">${bp}</td>
         </tr>
       `;
     }).join('');
   }

   function metricLabel(metric) {
     if (!metric) return 'SN List';
     if (metric === 'tested' || metric === 'total') return 'Total';
     if (metric === 'pass') return 'Pass';
     if (metric === 'fail') return 'Fail';
     if (metric && metric.startsWith('tray_')) return metric.replace('tray_', '').replace('_', ' ');
     if (metric === 'breakdown_bonepile') return 'Bonepile';
     if (metric === 'breakdown_fresh') return 'Fresh';
     if (metric === 'test_flow') return 'Test Flow';
     return metric;
   }

   function segmentLabel(seg) {
     if (seg === 'bp') return 'BP';
     if (seg === 'fresh') return 'Fresh';
     if (seg === 'total') return 'Total';
     return seg;
   }

   async function loadSnList(metric, segment, {sku = null, period = null} = {}) {
     let apiMetric = metric;
     if (metric === 'tested' && segment === 'total') apiMetric = 'total';
     else if (metric && metric.startsWith('tray_')) apiMetric = metric;
     else if (segment && segment !== 'total') apiMetric = 'tray_' + (metric || 'tested') + '_' + segment;

     const payload = getRangePayload();
     setLoading(true, 'Loading SN list...');
     const res = await fetch('/api/sn-list', {
       method: 'POST',
       headers: { 'Content-Type': 'application/json' },
       body: JSON.stringify({ ...payload, metric: apiMetric, sku, period, aggregation })
     });
     const data = await res.json();
     if (data.error) throw new Error(data.error);

     const title = metric ? `${metricLabel(metric)} • ${segmentLabel(segment || '')}` : 'SN List';
     document.getElementById('sn-modal-title').textContent = title;
     document.getElementById('sn-modal-subtitle').textContent = `${payload.start_datetime} → ${payload.end_datetime} (CA) • ${data.count || 0} SN`;
     renderSnModalRows(data.rows || []);
     setLoading(false);
   }

   // Helper to safely add event listeners
   function safeAddListener(id, event, handler) {
     try {
       const el = document.getElementById(id);
       if (el && typeof handler === 'function') {
         el.addEventListener(event, handler);
       }
     } catch (e) {
       console.error(`Error adding listener to ${id}:`, e);
     }
   }

   // Event listeners (wrapped in try-catch to prevent crashes)
   try {
     safeAddListener('theme-toggle', 'click', toggleTheme);
     safeAddListener('upload-btn', 'click', openModal);
     safeAddListener('close-modal', 'click', closeModal);
     safeAddListener('upload-modal', 'click', (e) => { if (e.target.id === 'upload-modal') closeModal(); });
     safeAddListener('close-sn-modal', 'click', closeSnModal);
     safeAddListener('sn-modal', 'click', (e) => { if (e.target.id === 'sn-modal') closeSnModal(); });
   } catch (e) {
     console.error('Error setting main event listeners:', e);
   }
   safeAddListener('browse-btn', 'click', (e) => {
     e.stopPropagation(); // Prevent bubbling to drop-zone
     const fi = document.getElementById('file-input');
     if (fi) fi.click();
   });

   // Bonepile upload (XLSX) + mapping UI
   const dz = document.getElementById('drop-zone');
   const fi = document.getElementById('file-input');
   if (dz && fi) {
     dz.addEventListener('click', (e) => {
       // Only trigger if click is on drop-zone itself or its children, but NOT on the browse button
       if (e.target.id !== 'browse-btn' && !e.target.closest('#browse-btn')) {
         fi.click();
       }
     });
     dz.addEventListener('dragover', (e) => { e.preventDefault(); dz.style.borderColor = 'rgba(99,102,241,.8)'; });
     dz.addEventListener('dragleave', () => { dz.style.borderColor = 'var(--color-border)'; });
     dz.addEventListener('drop', (e) => {
       e.preventDefault();
       dz.style.borderColor = 'var(--color-border)';
       const file = e.dataTransfer?.files?.[0];
       if (file) {
         // Prevent input change event from also triggering
         fi.value = '';
         uploadBonepileFile(file).catch(err => { setLoading(false); setApiStatus('Error: ' + err.message, 'err'); alert(err.message); });
       }
     });
     fi.addEventListener('change', (e) => {
       const file = e.target.files && e.target.files[0];
       if (file) {
         uploadBonepileFile(file).catch(err => { setLoading(false); setApiStatus('Error: ' + err.message, 'err'); alert(err.message); });
       }
     });
   }
   const bpRefresh = document.getElementById('bp-refresh');
   if (bpRefresh) bpRefresh.addEventListener('click', () => refreshBonepilePanel().catch(() => {}));
   const bpClearCache = document.getElementById('bp-clear-cache');
   if (bpClearCache) bpClearCache.addEventListener('click', async () => {
     try {
       if (!confirm('Clear cache will delete local analytics cache and uploaded bonepile file. Continue?')) return;
       setLoading(true, 'Clearing cache...');
       const res = await fetch('/api/clear-cache', { method: 'POST' });
       const data = await res.json();
       if (data.error) throw new Error(data.error);
       await refreshBonepilePanel();
       setLoading(false);
       alert('Cache cleared. Upload a new bonepile file and run Manual Scan or Apply Filter to rebuild.');
     } catch (err) {
       console.error(err);
       setLoading(false);
       alert('Error: ' + (err?.message || err));
     }
   });
   const bpParseAll = document.getElementById('bp-parse-all');
   if (bpParseAll) bpParseAll.addEventListener('click', () => parseBonepile(null).catch(err => { setApiStatus('Error: ' + err.message, 'err'); alert(err.message); }));
   const bpSheets = document.getElementById('bp-sheets');
   if (bpSheets) bpSheets.addEventListener('click', (e) => {
     const autoBtn = e.target?.closest?.('button[data-bp-auto]');
     const saveBtn = e.target?.closest?.('button[data-bp-save]');
     const parseBtn = e.target?.closest?.('button[data-bp-parse]');
     if (autoBtn) {
       const sheet = autoBtn.getAttribute('data-bp-auto');
       // just refresh (auto defaults get applied on render)
       refreshBonepilePanel().catch(() => {});
     }
     if (saveBtn) {
       const sheet = saveBtn.getAttribute('data-bp-save');
       saveBonepileMapping(sheet).catch(err => { setApiStatus('Error: ' + err.message, 'err'); alert(err.message); });
     }
     if (parseBtn) {
       const sheet = parseBtn.getAttribute('data-bp-parse');
       parseBonepile(sheet).catch(err => { setApiStatus('Error: ' + err.message, 'err'); alert(err.message); });
     }
   });

   function applyFilter() {
     runQuery().catch(err => {
       console.error(err);
       setLoading(false);
       setApiStatus('Error: ' + err.message, 'err');
       alert('Error: ' + err.message);
     });
     loadDispositionPanel().catch(err => {
       console.error('loadDispositionPanel error:', err);
     });
   }
   safeAddListener('apply-filter', 'click', applyFilter);

   // Do NOT auto-apply on date/time change; user must click Apply Filter

  // Export buttons
  document.getElementById('export-all').addEventListener('click', () => {
    downloadCsv('dashboard').catch(err => {
      console.error(err);
      setLoading(false);
      alert('Error: ' + err.message);
    });
  });
  safeAddListener('export-summary-xlsx', 'click', () => {
    downloadExcel('summary').catch(err => {
      console.error(err);
      setLoading(false);
      alert('Error: ' + err.message);
    });
  });
  safeAddListener('export-sku-xlsx', 'click', () => {
    downloadExcel('sku').catch(err => {
      console.error(err);
      setLoading(false);
      alert('Error: ' + err.message);
    });
  });
  safeAddListener('export-breakdown', 'click', () => {
    downloadCsv('breakdown').catch(err => {
      console.error(err);
      setLoading(false);
      alert('Error: ' + err.message);
    });
  });
  safeAddListener('export-flow', 'click', () => {
    downloadCsv('test_flow').catch(err => {
      console.error(err);
      setLoading(false);
      alert('Error: ' + err.message);
    });
  });
  safeAddListener('export-dispo-summary', 'click', () => {
    downloadCsv('disposition_summary').catch(err => {
      console.error(err);
      setLoading(false);
      alert('Error: ' + err.message);
    });
  });

  safeAddListener('export-dispo-by-sku-excel', 'click', () => {
    downloadExcel('disposition_by_sku').catch(err => {
      console.error(err);
      setLoading(false);
      alert('Error: ' + err.message);
    });
  });

   // Metric drilldown clicks (Summary matrix)
   safeAddListener('summary-matrix', 'click', (e) => {
     const btn = e.target?.closest?.('button[data-metric][data-segment]');
     if (!btn) return;
     if (btn.disabled) return;
     const metric = btn.getAttribute('data-metric');
     const segment = btn.getAttribute('data-segment');
     openSnModal();
     loadSnList(metric, segment).catch(err => {
       console.error(err);
       setLoading(false);
       alert('Error: ' + err.message);
     });
   });

   safeAddListener('summary-matrix', 'click', (e) => {
     const btn = e.target?.closest?.('button.metric-btn');
     if (!btn || btn.disabled) return;
     const metric = btn.getAttribute('data-metric');
     const segment = btn.getAttribute('data-segment') || 'total';
     openSnModal();
     loadSnList(metric, segment).catch(err => {
       console.error(err);
       setLoading(false);
       alert('Error: ' + err.message);
     });
   });
   safeAddListener('kpi-row', 'click', (e) => {
     const btn = e.target?.closest?.('button.metric-btn');
     if (!btn || btn.disabled) return;
     const metric = btn.getAttribute('data-metric');
     const segment = btn.getAttribute('data-segment') || 'total';
     openSnModal();
     loadSnList(metric, segment).catch(err => {
       console.error(err);
       setLoading(false);
       alert('Error: ' + err.message);
     });
   });

   // SKU drilldown clicks (each number becomes a button)
   safeAddListener('sku-table', 'click', (e) => {
     const btn = e.target?.closest?.('button[data-sku][data-metric]');
     if (!btn) return;
     if (btn.disabled) return;
     const sku = btn.getAttribute('data-sku');
     const metric = btn.getAttribute('data-metric');
     openSnModal();
     loadSnList(metric, 'total', { sku }).catch(err => {
       console.error(err);
       setLoading(false);
       alert('Error: ' + err.message);
     });
   });

   safeAddListener('breakdown-table', 'click', (e) => {
     const btn = e.target?.closest?.('button.metric-btn[data-period]');
     if (!btn || btn.disabled) return;
     const period = btn.getAttribute('data-period');
     const metric = btn.getAttribute('data-metric');
     openSnModal();
     loadSnList(metric, null, { period }).catch(err => {
       console.error(err);
       setLoading(false);
       alert('Error: ' + err.message);
     });
   });

  safeAddListener('test-flow-table', 'click', (e) => {
    const btn = e.target?.closest?.('button[data-flow="1"]');
    if (!btn || btn.disabled) return;
    const station = btn.getAttribute('data-station');
    const sku = (btn.getAttribute('data-sku') || '').trim() || null;

    const payload = getRangePayload();
    openSnModal();
    setLoading(true, 'Loading SN list...');
    Promise.all([
      fetch('/api/sn-list', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ ...payload, aggregation, metric: 'test_flow', sku, station, outcome: 'pass' }) }).then(r => r.json()),
      fetch('/api/sn-list', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ ...payload, aggregation, metric: 'test_flow', sku, station, outcome: 'fail' }) }).then(r => r.json())
    ])
      .then(([passData, failData]) => {
        if (passData.error) throw new Error(passData.error);
        if (failData.error) throw new Error(failData.error);
        const title = `Test Flow • ${station}${sku ? (' • ' + sku) : ''}`;
        document.getElementById('sn-modal-title').textContent = title;
        document.getElementById('sn-modal-subtitle').textContent = `${payload.start_datetime} → ${payload.end_datetime} (CA) • Pass: ${passData.count || 0} • Fail: ${failData.count || 0}`;
        renderTestFlowSnModal(passData.rows || [], failData.rows || []);
        setLoading(false);
      })
      .catch(err => {
        console.error(err);
        setLoading(false);
        alert('Error: ' + err.message);
      });
  });

  // NV Disposition event listeners (wrapped in try-catch)
  try {
    ['dispo-sum-total-btn','dispo-sum-waiting-btn','dispo-sum-complete-btn','dispo-sum-trays-bp-btn','dispo-sum-all-pass-btn'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.addEventListener('click', () => {
        const metric = el.getAttribute('data-dispo-metric');
        if (metric) loadDispositionSnList(metric, null, null).catch(err => { setLoading(false); alert('Error: ' + err.message); });
      });
    });
    const dispoSkuTable = document.getElementById('dispo-sku-table');
    if (dispoSkuTable) dispoSkuTable.addEventListener('click', (e) => {
      const btn = e.target?.closest?.('button[data-dispo-metric][data-dispo-segment="sku"]');
      if (!btn || btn.disabled) return;
      const metric = btn.getAttribute('data-dispo-metric');
      const sku = btn.getAttribute('data-dispo-sku') || null;
      if (metric) loadDispositionSnList(metric, sku, null).catch(err => { setLoading(false); alert('Error: ' + err.message); });
    });
    const dispoPeriodTable = document.getElementById('dispo-period-table');
    if (dispoPeriodTable) dispoPeriodTable.addEventListener('click', (e) => {
      const btn = e.target?.closest?.('button[data-dispo-metric][data-dispo-segment="period"]');
      if (!btn || btn.disabled) return;
      const metric = btn.getAttribute('data-dispo-metric');
      const period = btn.getAttribute('data-dispo-period') || null;
      if (metric) loadDispositionSnList(metric, null, period).catch(err => { setLoading(false); alert('Error: ' + err.message); });
    });
    const dispoTraySkuTable = document.getElementById('dispo-tray-sku-table');
    if (dispoTraySkuTable) dispoTraySkuTable.addEventListener('click', (e) => {
      const btn = e.target?.closest?.('button[data-dispo-metric][data-dispo-segment="tray_sku"]');
      if (!btn || btn.disabled) return;
      const metric = btn.getAttribute('data-dispo-metric');
      const sku = btn.getAttribute('data-dispo-sku') || null;
      if (metric) loadDispositionSnList(metric, sku, null).catch(err => { setLoading(false); alert('Error: ' + err.message); });
    });
    document.querySelectorAll('.dispo-agg-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const agg = btn.getAttribute('data-dispo-agg');
        if (!agg) return;
        dispoAggregation = agg;
        document.querySelectorAll('.dispo-agg-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        loadDispositionPanel().catch(() => {});
      });
    });
    const closeDispoSnModalEl = document.getElementById('close-dispo-sn-modal');
    if (closeDispoSnModalEl) closeDispoSnModalEl.addEventListener('click', closeDispoSnModal);
    const dispoSnModalEl = document.getElementById('dispo-sn-modal');
    if (dispoSnModalEl) dispoSnModalEl.addEventListener('click', (e) => { if (e.target.id === 'dispo-sn-modal') closeDispoSnModal(); });
  } catch (e) {
    console.error('Error setting disposition listeners:', e);
  }

  const onAggClick = (a) => {
    setAgg(a);
    // Refresh view using the same cached data (no scan).
    runQuery().catch(err => {
      console.error(err);
      setLoading(false);
      alert('Error: ' + err.message);
    });
  };
  try {
    const aggDaily = document.getElementById('agg-daily');
    const aggWeekly = document.getElementById('agg-weekly');
    const aggMonthly = document.getElementById('agg-monthly');
    if (aggDaily) aggDaily.addEventListener('click', () => onAggClick('daily'));
    if (aggWeekly) aggWeekly.addEventListener('click', () => onAggClick('weekly'));
    if (aggMonthly) aggMonthly.addEventListener('click', () => onAggClick('monthly'));
  } catch (e) {
    console.error('Error setting aggregation listeners:', e);
  }

   // Set default dates (last 7 days) - MOVED TO INIT BLOCK BELOW

  // Live update range notes when user edits range inputs
  try {
    ['start-date','end-date','start-time','end-time'].forEach((id) => {
      const el = document.getElementById(id);
      if (el && typeof updateRangeNotes === 'function') {
        el.addEventListener('change', updateRangeNotes);
      }
    });
  } catch (e) {
    console.error('Error setting range input listeners:', e);
  }

   // Element SDK integration
   async function onConfigChange(newConfig) {
     config = { ...config, ...newConfig };
     const titleEl = document.getElementById('dashboard-title');
     if (titleEl) titleEl.textContent = config.dashboard_title || defaultConfig.dashboard_title;
     const summaryEl = document.getElementById('summary-title');
     if (summaryEl) summaryEl.textContent = config.summary_title || defaultConfig.summary_title;
   }

   function mapToCapabilities(cfg) {
     return {
       recolorables: [
         { get: () => cfg.background_color || defaultConfig.background_color, set: (value) => { cfg.background_color = value; window.elementSdk.setConfig({ background_color: value }); } },
         { get: () => cfg.surface_color || defaultConfig.surface_color, set: (value) => { cfg.surface_color = value; window.elementSdk.setConfig({ surface_color: value }); } },
         { get: () => cfg.text_color || defaultConfig.text_color, set: (value) => { cfg.text_color = value; window.elementSdk.setConfig({ text_color: value }); } },
         { get: () => cfg.primary_color || defaultConfig.primary_color, set: (value) => { cfg.primary_color = value; window.elementSdk.setConfig({ primary_color: value }); } },
         { get: () => cfg.accent_color || defaultConfig.accent_color, set: (value) => { cfg.accent_color = value; window.elementSdk.setConfig({ accent_color: value }); } }
       ],
       borderables: [],
       fontEditable: undefined,
       fontSizeable: undefined
     };
   }
   function mapToEditPanelValues(cfg) {
     return new Map([
       ['dashboard_title', cfg.dashboard_title || defaultConfig.dashboard_title],
       ['summary_title', cfg.summary_title || defaultConfig.summary_title]
     ]);
   }
   if (window.elementSdk) {
     window.elementSdk.init({ defaultConfig, onConfigChange, mapToCapabilities, mapToEditPanelValues });
   }

   function applyStatusFromPayload(data) {
     try {
       const c = (data && data.cache) ? data.cache : {};
       window.__scanIntervalSeconds = c.scan_interval_seconds || 60;
       window.__nextAutoScanMs = c.next_auto_scan_ms || null;

       const fmtRange = (minMs, maxMs) => {
         if (!minMs || !maxMs) return 'no cache yet';
         const min = fmtDateTimeCAFromMs(minMs);
         const max = fmtDateTimeCAFromMs(maxMs);
         return `${min} → ${max}`;
       };
       document.getElementById('cache-data-coverage').textContent = fmtRange(c.min_ca_ms, c.max_ca_ms);
       document.getElementById('cache-last-scan').textContent = c.last_scan_ca_ms ? fmtDateTimeCAFromMs(c.last_scan_ca_ms) : 'unknown';
     } catch (e) {}
    try {
      _applyBonepileStatus((data && data.bonepile) ? data.bonepile : null);
    } catch (e) {}
   }

   function startStatusStream() {
     if (!window.EventSource) return;
     try {
       const es = new EventSource('/api/events');
       es.addEventListener('status', (evt) => {
         try {
           const data = JSON.parse(evt.data);
           applyStatusFromPayload(data);
           // Do NOT auto-run runQuery/loadDispositionPanel on scan complete; user must click Apply Filter.
         } catch (e) {}
       });
       es.addEventListener('error', () => {
         // fallback: nothing, user can press Refresh
       });
       window.__statusEventSource = es;
     } catch (e) {}
   }

   // Init (no auto-polling; status updates come from SSE)
   // Wrap in try-catch to prevent silent crashes
   try {
     // Ensure default dates: today 12:00 AM - 11:59 PM (same day). Do NOT auto-run query; user must click Apply Filter.
     (function setDefaultRange() {
       try {
         const startEl = document.getElementById('start-date');
         const endEl = document.getElementById('end-date');
         const startTimeEl = document.getElementById('start-time');
         const endTimeEl = document.getElementById('end-time');
         if (!startEl || !endEl) {
           console.warn('Date inputs not found, retrying...');
           setTimeout(setDefaultRange, 100);
           return;
         }
         const now = new Date();
         if (!startEl.value) startEl.value = fmtDateCA(now);
         if (!endEl.value) endEl.value = fmtDateCA(now);
         if (startTimeEl && !startTimeEl.value) startTimeEl.value = '00:00';
         if (endTimeEl && !endTimeEl.value) endTimeEl.value = '23:59';
         if (typeof updateRangeNotes === 'function') updateRangeNotes();
       } catch (e) {
         console.error('Error setting default range:', e);
       }
     })();
     
     refreshCacheCoverage().catch(() => {});
     if (typeof startStatusStream === 'function') startStatusStream();
     if (typeof startCountdownLoop === 'function') startCountdownLoop();
   } catch (e) {
      console.error('Init error:', e);
      setApiStatus('Init failed: ' + (e.message || e), 'err');
    }
 </script>
</body>
</html>
